{% extends "base.html" %}

{% block title %}장비 목록{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-list me-2"></i>장비 목록</h2>
                <button class="btn btn-primary" onclick="addEquipment()">
                    <i class="fas fa-plus me-2"></i>장비 추가
                </button>
            </div>
            
            <!-- 장비 목록 테이블 -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>관리번호</th>
                                    <th>장비명</th>
                                    <th>모델명</th>
                                    <th>제조사</th>
                                    <th>위치</th>
                                    <th>담당자</th>
                                    <th>상태</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="equipmentTableBody">
                                <!-- 장비 목록이 여기에 동적으로 로드됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 장비 추가/수정 모달 -->
<div class="modal fade" id="equipmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="equipmentModalTitle">장비 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="equipmentForm">
                    <input type="hidden" id="hiddenEquipmentId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">장비명 *</label>
                                <input type="text" class="form-control" id="equipmentName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">관리번호 *</label>
                                <input type="text" class="form-control" id="equipmentId" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">모델명</label>
                                <input type="text" class="form-control" id="equipmentModel">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">제조사</label>
                                <input type="text" class="form-control" id="equipmentManufacturer">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">시리얼 번호</label>
                                <input type="text" class="form-control" id="equipmentSerial">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">위치 *</label>
                                <input type="text" class="form-control" id="equipmentLocation" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">담당자</label>
                                <input type="text" class="form-control" id="equipmentManager">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">상태</label>
                                <select class="form-control" id="equipmentStatus">
                                    <option value="사용가능">사용가능</option>
                                    <option value="사용중">사용중</option>
                                    <option value="점검중">점검중</option>
                                    <option value="고장">고장</option>
                                    <option value="폐기">폐기</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">구매일</label>
                                <input type="date" class="form-control" id="equipmentPurchaseDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">구매가격</label>
                                <input type="number" class="form-control" id="equipmentPrice">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">정기점검일</label>
                                <input type="date" class="form-control" id="equipmentMaintenanceDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">보증만료일</label>
                                <input type="date" class="form-control" id="equipmentWarrantyExpiry">
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">사양 및 특징</label>
                        <textarea class="form-control" id="equipmentSpecifications" rows="3"></textarea>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">비고</label>
                        <textarea class="form-control" id="equipmentNotes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-danger" id="deleteEquipmentBtn" onclick="deleteEquipment()" style="display: none;">삭제</button>
                <button type="button" class="btn btn-primary" onclick="saveEquipment()">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- 장비 상세보기 모달 -->
<div class="modal fade" id="equipmentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">장비 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-3">기본 정보</h6>
                        <div class="detail-item">
                            <label class="detail-label">장비명</label>
                            <div class="detail-value" id="detailName"></div>
                        </div>
                        <div class="detail-item">
                            <label class="detail-label">모델명</label>
                            <div class="detail-value" id="detailModel"></div>
                        </div>
                        <div class="detail-item">
                            <label class="detail-label">제조사</label>
                            <div class="detail-value" id="detailManufacturer"></div>
                        </div>
                        <div class="detail-item">
                            <label class="detail-label">시리얼 번호</label>
                            <div class="detail-value" id="detailSerial"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="mb-3">관리 정보</h6>
                        <div class="detail-item">
                            <label class="detail-label">관리번호</label>
                            <div class="detail-value" id="detailEquipmentId"></div>
                        </div>
                        <div class="detail-item">
                            <label class="detail-label">위치</label>
                            <div class="detail-value" id="detailLocation"></div>
                        </div>
                        <div class="detail-item">
                            <label class="detail-label">담당자</label>
                            <div class="detail-value" id="detailManager"></div>
                        </div>
                        <div class="detail-item">
                            <label class="detail-label">상태</label>
                            <div class="detail-value" id="detailStatus"></div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-3">구매 정보</h6>
                        <div class="detail-item">
                            <label class="detail-label">구매일</label>
                            <div class="detail-value" id="detailPurchaseDate"></div>
                        </div>
                        <div class="detail-item">
                            <label class="detail-label">구매가격</label>
                            <div class="detail-value" id="detailPrice"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="mb-3">점검 정보</h6>
                        <div class="detail-item">
                            <label class="detail-label">정기점검일</label>
                            <div class="detail-value" id="detailMaintenanceDate"></div>
                        </div>
                        <div class="detail-item">
                            <label class="detail-label">보증만료일</label>
                            <div class="detail-value" id="detailWarrantyExpiry"></div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="detail-item">
                    <label class="detail-label">사양 및 특징</label>
                    <div class="detail-value" id="detailSpecifications"></div>
                </div>
                <div class="detail-item">
                    <label class="detail-label">비고</label>
                    <div class="detail-value" id="detailNotes"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="editEquipmentFromDetail()">수정</button>
            </div>
        </div>
    </div>
</div>

<script>
let equipmentList = [];

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadEquipmentData();
});

// 장비 데이터 로드
async function loadEquipmentData() {
    try {
        const response = await fetch('/equipment/api/equipment');
        const data = await response.json();
        
        console.log('장비 데이터 로드 결과:', data);
        
        if (data.success && data.equipment) {
            equipmentList = data.equipment;
            console.log('equipmentList 업데이트됨:', equipmentList);
            renderEquipmentTable(equipmentList);
        } else {
            console.error('장비 데이터 로드 실패:', data.error || '데이터 없음');
            equipmentList = [];
            renderEquipmentTable([]);
        }
    } catch (error) {
        console.error('장비 데이터 로드 중 오류:', error);
        equipmentList = [];
        renderEquipmentTable([]);
    }
}

// 장비 테이블 렌더링
function renderEquipmentTable(equipment) {
    const tbody = document.getElementById('equipmentTableBody');
    let html = '';
    
    if (equipment.length === 0) {
        html = `
        <tr>
            <td colspan="8" class="text-center text-muted py-4">
                <i class="fas fa-box-open fa-2x mb-2"></i><br>
                등록된 장비가 없습니다.<br>
                <button class="btn btn-primary mt-2" onclick="addEquipment()">
                    <i class="fas fa-plus me-1"></i>첫 번째 장비 등록하기
                </button>
            </td>
        </tr>`;
    } else {
        equipment.forEach(eq => {
            html += `
            <tr>
                <td>${eq.equipment_id || '-'}</td>
                <td><a href="#" onclick="viewEquipmentDetail(${eq.id})" class="text-primary">${eq.name}</a></td>
                <td>${eq.model || '-'}</td>
                <td>${eq.manufacturer || '-'}</td>
                <td>${eq.location || '-'}</td>
                <td>${eq.manager || '-'}</td>
                <td>
                    <span class="status-badge status-${eq.status ? eq.status.replace(/\s+/g, '') : 'unknown'}">${eq.status || '알 수 없음'}</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editEquipment(${eq.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteEquipment(${eq.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
        });
    }
    
    tbody.innerHTML = html;
}

// 장비 추가 모달 열기
function addEquipment() {
    document.getElementById('equipmentModalTitle').textContent = '장비 추가';
    document.getElementById('equipmentForm').reset();
    document.getElementById('hiddenEquipmentId').value = '';
    document.getElementById('deleteEquipmentBtn').style.display = 'none';
    
    // 관리번호 자동 생성
    const nextId = 'EQ' + String(Date.now()).slice(-6);
    document.getElementById('equipmentId').value = nextId;
    
    new bootstrap.Modal(document.getElementById('equipmentModal')).show();
}

// 장비 상세보기
function viewEquipmentDetail(id) {
    const equipment = equipmentList.find(eq => eq.id === id);
    if (!equipment) return;
    
    // 기본 정보
    document.getElementById('detailName').textContent = equipment.name;
    document.getElementById('detailModel').textContent = equipment.model || '';
    document.getElementById('detailManufacturer').textContent = equipment.manufacturer || '';
    document.getElementById('detailSerial').textContent = equipment.serial_number || '';
    
    // 관리 정보
    document.getElementById('detailEquipmentId').textContent = equipment.equipment_id || '';
    document.getElementById('detailLocation').textContent = equipment.location || '';
    document.getElementById('detailManager').textContent = equipment.manager || '';
    document.getElementById('detailStatus').innerHTML = equipment.status ? 
        `<span class="status-badge status-${equipment.status.replace(/\s+/g, '')}">${equipment.status}</span>` : '';
    
    // 구매 정보
    document.getElementById('detailPurchaseDate').textContent = equipment.purchase_date || '';
    document.getElementById('detailPrice').textContent = equipment.purchase_price ? 
        new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(equipment.purchase_price) : '';
    
    // 점검 정보
    document.getElementById('detailMaintenanceDate').textContent = equipment.maintenance_date || '';
    document.getElementById('detailWarrantyExpiry').textContent = equipment.warranty_expiry || '';
    
    // 상세 정보
    document.getElementById('detailSpecifications').textContent = equipment.specifications || '';
    document.getElementById('detailNotes').textContent = equipment.notes || '';
    
    // 상세보기에서 수정할 수 있도록 equipment ID 저장
    document.getElementById('equipmentDetailModal').dataset.equipmentId = id;
    
    new bootstrap.Modal(document.getElementById('equipmentDetailModal')).show();
}

// 상세보기에서 수정 모달로 전환
function editEquipmentFromDetail() {
    const id = document.getElementById('equipmentDetailModal').dataset.equipmentId;
    
    // 상세보기 모달 닫기
    bootstrap.Modal.getInstance(document.getElementById('equipmentDetailModal')).hide();
    
    // 수정 모달 열기
    setTimeout(() => {
        editEquipment(parseInt(id));
    }, 300);
}

// 장비 수정
function editEquipment(id) {
    console.log('수정 요청 ID:', id, 'equipmentList:', equipmentList);
    const equipment = equipmentList.find(eq => eq.id === id);
    if (!equipment) {
        console.error('장비를 찾을 수 없습니다. ID:', id);
        alert('장비를 찾을 수 없습니다.');
        return;
    }
    
    document.getElementById('equipmentModalTitle').textContent = '장비 수정';
    document.getElementById('hiddenEquipmentId').value = equipment.id;
    document.getElementById('equipmentName').value = equipment.name;
    document.getElementById('equipmentModel').value = equipment.model || '';
    document.getElementById('equipmentManufacturer').value = equipment.manufacturer || '';
    document.getElementById('equipmentId').value = equipment.equipment_id || '';
    document.getElementById('equipmentSerial').value = equipment.serial_number || '';
    document.getElementById('equipmentLocation').value = equipment.location || '';
    document.getElementById('equipmentManager').value = equipment.manager || '';
    document.getElementById('equipmentStatus').value = equipment.status;
    document.getElementById('equipmentPurchaseDate').value = equipment.purchase_date || '';
    document.getElementById('equipmentPrice').value = equipment.purchase_price || '';
    document.getElementById('equipmentMaintenanceDate').value = equipment.maintenance_date || '';
    document.getElementById('equipmentWarrantyExpiry').value = equipment.warranty_expiry || '';
    document.getElementById('equipmentSpecifications').value = equipment.specifications || '';
    document.getElementById('equipmentNotes').value = equipment.notes || '';
    document.getElementById('deleteEquipmentBtn').style.display = 'inline-block';
    
    new bootstrap.Modal(document.getElementById('equipmentModal')).show();
}

// 장비 저장
async function saveEquipment() {
    const id = document.getElementById('hiddenEquipmentId').value;
    console.log('저장 요청 ID:', id);
    const equipmentData = {
        name: document.getElementById('equipmentName').value,
        model: document.getElementById('equipmentModel').value,
        manufacturer: document.getElementById('equipmentManufacturer').value,
        equipment_id: document.getElementById('equipmentId').value,
        serial_number: document.getElementById('equipmentSerial').value,
        location: document.getElementById('equipmentLocation').value,
        manager: document.getElementById('equipmentManager').value,
        status: document.getElementById('equipmentStatus').value,
        purchase_date: document.getElementById('equipmentPurchaseDate').value,
        purchase_price: document.getElementById('equipmentPrice').value,
        maintenance_date: document.getElementById('equipmentMaintenanceDate').value,
        warranty_expiry: document.getElementById('equipmentWarrantyExpiry').value,
        specifications: document.getElementById('equipmentSpecifications').value,
        notes: document.getElementById('equipmentNotes').value
    };
    
    if (!equipmentData.name.trim() || !equipmentData.location.trim()) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }
    
    try {
        let response;
        if (id) {
            response = await fetch(`/equipment/api/equipment/${id}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(equipmentData)
            });
        } else {
            response = await fetch('/equipment/api/equipment/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(equipmentData)
            });
        }
        
        const result = await response.json();
        if (result.success) {
            alert('저장되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('equipmentModal')).hide();
            loadEquipmentData();
        } else {
            alert('오류: ' + (result.error || '저장에 실패했습니다.'));
        }
    } catch (error) {
        console.error('저장 중 오류:', error);
        alert('저장 중 오류가 발생했습니다.');
    }
}

// 장비 삭제
async function deleteEquipment(id) {
    if (!id) {
        id = document.getElementById('hiddenEquipmentId').value;
    }
    
    console.log('삭제 요청 ID:', id);
    
    if (!id) {
        console.error('삭제할 장비 ID가 없습니다.');
        alert('삭제할 장비를 선택해주세요.');
        return;
    }
    
    if (confirm('이 장비를 삭제하시겠습니까?')) {
        try {
            console.log('삭제 API 호출:', `/equipment/api/equipment/${id}/delete`);
            const response = await fetch(`/equipment/api/equipment/${id}/delete`, {
                method: 'POST'
            });
            
            const result = await response.json();
            console.log('삭제 API 응답:', result);
            
            if (result.success) {
                alert('삭제되었습니다.');
                if (document.getElementById('equipmentModal').classList.contains('show')) {
                    bootstrap.Modal.getInstance(document.getElementById('equipmentModal')).hide();
                }
                loadEquipmentData();
            } else {
                alert('오류: ' + (result.error || '삭제에 실패했습니다.'));
            }
        } catch (error) {
            console.error('삭제 중 오류:', error);
            alert('삭제 중 오류가 발생했습니다.');
        }
    }
}
</script>
{% endblock %}