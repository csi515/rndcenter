{% extends "base.html" %}

{% block title %}작업 목록 - R&D 센터 관리시스템{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-file-alt"></i> 작업 목록</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProcedureModal">
                <i class="fas fa-plus"></i> 절차서 추가
            </button>
        </div>
    </div>
</div>

<!-- Procedures Table -->
<div class="card">
    <div class="card-header">
        <div class="row">
            <div class="col-md-6">
                <h5 class="mb-0">작업절차서 목록</h5>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <select class="form-select" id="yearFilter">
                        <option value="">전체 연도</option>
                        <option value="2025">2025년</option>
                        <option value="2024">2024년</option>
                        <option value="2023">2023년</option>
                        <option value="2022">2022년</option>
                        <option value="2021">2021년</option>
                    </select>
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped" id="proceduresTable">
                <thead>
                    <tr>
                        <th>제목</th>
                        <th>설명</th>
                        <th>버전(연도)</th>
                        <th>작성자</th>
                        <th>검토일</th>
                        <th>상태</th>
                        <th>절차서</th>
                        <th>위험성평가</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody>
                    {% for procedure in procedures %}
                    <tr data-id="{{ procedure.id }}">
                        <td>{{ procedure.title }}</td>
                        <td>{{ procedure.description[:50] }}{% if procedure.description|length > 50 %}...{% endif %}</td>
                        <td>{{ procedure.version }}년</td>
                        <td>{{ procedure.created_by }}</td>
                        <td>{{ procedure.review_date }}</td>
                        <td>
                            <span class="badge {% if procedure.status == '유효' %}bg-success{% elif procedure.status == '검토중' %}bg-warning{% else %}bg-secondary{% endif %}">
                                {{ procedure.status }}
                            </span>
                        </td>
                        <td>
                            {% if procedure.procedure_link %}
                            <a href="{{ procedure.procedure_link }}" target="_blank" class="btn btn-sm btn-outline-primary" title="절차서">
                                <i class="fas fa-file-alt"></i>
                            </a>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if procedure.risk_assessment_link %}
                            <a href="{{ procedure.risk_assessment_link }}" target="_blank" class="btn btn-sm btn-outline-danger" title="위험성평가">
                                <i class="fas fa-exclamation-triangle"></i>
                            </a>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" data-procedure-id="{{ procedure.id }}" onclick="editProcedure(this.dataset.procedureId)" title="수정">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



<!-- Add Procedure Modal -->
<div class="modal fade" id="addProcedureModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('safety.add_procedure') }}">
                <div class="modal-header">
                    <h5 class="modal-title">작업절차서 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">제목 *</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">카테고리</label>
                            <select class="form-select" name="category">
                                <option value="실험절차">실험절차</option>
                                <option value="장비운영">장비운영</option>
                                <option value="안전관리">안전관리</option>
                                <option value="위험성평가">위험성평가</option>
                                <option value="응급처치">응급처치</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">설명 *</label>
                        <textarea class="form-control" name="description" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">버전(연도)</label>
                            <select class="form-select" name="version">
                                <option value="">선택하세요</option>
                                {% for year in range(current_year, current_year-9, -1) %}
                                <option value="{{ year }}">{{ year }}년</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">작성자 *</label>
                            <input type="text" class="form-control" name="created_by" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">검토일</label>
                            <input type="date" class="form-control" name="review_date">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">절차서 링크</label>
                            <input type="url" class="form-control" name="procedure_link" placeholder="https://...">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">위험성평가 링크</label>
                            <input type="url" class="form-control" name="risk_assessment_link" placeholder="https://...">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">상태</label>
                            <select class="form-select" name="status">
                                <option value="유효">유효</option>
                                <option value="검토중">검토중</option>
                                <option value="폐기">폐기</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <!-- 빈 공간 -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">추가</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Procedure Modal -->
<div class="modal fade" id="viewProcedureModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">작업절차서 상세</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="procedureDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary">파일 열기</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Procedure Modal -->
<div class="modal fade" id="editProcedureModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">절차서 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('safety.update_procedure') }}">
                <div class="modal-body">
                    <input type="hidden" id="editProcedureId" name="procedure_id">
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="editTitle" class="form-label">제목 *</label>
                            <input type="text" class="form-control" id="editTitle" name="title" required>
                        </div>
                        <div class="col-md-4">
                            <!-- 카테고리 입력란 제거 -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">설명</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="editVersion" class="form-label">버전(연도)</label>
                            <select class="form-select" id="editVersion" name="version">
                                <option value="">선택하세요</option>
                                {% for year in range(current_year, current_year-9, -1) %}
                                <option value="{{ year }}">{{ year }}년</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="editCreatedBy" class="form-label">작성자</label>
                            <input type="text" class="form-control" id="editCreatedBy" name="created_by">
                        </div>
                        <div class="col-md-4">
                            <label for="editStatus" class="form-label">상태</label>
                            <select class="form-select" id="editStatus" name="status">
                                <option value="유효">유효</option>
                                <option value="검토중">검토중</option>
                                <option value="폐기">폐기</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editReviewDate" class="form-label">검토 예정일</label>
                        <input type="date" class="form-control" id="editReviewDate" name="review_date">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editProcedureLink" class="form-label">절차서 링크</label>
                        <input type="url" class="form-control" id="editProcedureLink" name="procedure_link" placeholder="https://example.com/procedure.pdf">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editRiskAssessmentLink" class="form-label">위험성평가 링크</label>
                        <input type="url" class="form-control" id="editRiskAssessmentLink" name="risk_assessment_link" placeholder="https://example.com/risk-assessment.pdf">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">수정 완료</button>
                    <button type="button" class="btn btn-danger ms-auto" id="deleteProcedureBtn">삭제</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewProcedure(procedure) {
    const categoryClass = procedure.category === '위험성평가' ? 'danger' : procedure.category === '안전관리' ? 'warning' : 'info';
    const statusClass = procedure.status === '유효' ? 'success' : procedure.status === '검토중' ? 'warning' : 'secondary';
    
    const details = `
        <div class="row mb-3">
            <div class="col-6"><strong>제목:</strong></div>
            <div class="col-6">${procedure.title}</div>
        </div>
        <div class="row mb-3">
            <div class="col-6"><strong>카테고리:</strong></div>
            <div class="col-6"><span class="badge bg-${categoryClass}">${procedure.category}</span></div>
        </div>
        <div class="row mb-3">
            <div class="col-6"><strong>버전:</strong></div>
            <div class="col-6">${procedure.version}년</div>
        </div>
        <div class="row mb-3">
            <div class="col-6"><strong>작성자:</strong></div>
            <div class="col-6">${procedure.created_by}</div>
        </div>
        <div class="row mb-3">
            <div class="col-6"><strong>검토일:</strong></div>
            <div class="col-6">${procedure.review_date || '미정'}</div>
        </div>
        <div class="row mb-3">
            <div class="col-6"><strong>상태:</strong></div>
            <div class="col-6"><span class="badge bg-${statusClass}">${procedure.status}</span></div>
        </div>
        <hr>
        <div class="mb-3">
            <strong>설명:</strong>
            <p class="mt-2">${procedure.description}</p>
        </div>
        ${procedure.procedure_link ? `
        <div class="mb-3">
            <strong>절차서 링크:</strong>
            <p class="mt-2"><a href="${procedure.procedure_link}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-file-alt"></i> 절차서 보기</a></p>
        </div>
        ` : ''}
        ${procedure.risk_assessment_link ? `
        <div class="mb-3">
            <strong>위험성평가 링크:</strong>
            <p class="mt-2"><a href="${procedure.risk_assessment_link}" target="_blank" class="btn btn-sm btn-outline-danger"><i class="fas fa-exclamation-triangle"></i> 위험성평가 보기</a></p>
        </div>
        ` : ''}
    `;
    
    document.getElementById('procedureDetails').innerHTML = details;
    new bootstrap.Modal(document.getElementById('viewProcedureModal')).show();
}

// Edit procedure function
function editProcedure(procedureId) {
    // Find by ID in procedures array passed from backend
    const procedures = JSON.parse('{{ procedures|tojson|safe }}');
    const procedure = procedures.find(p => p.id === parseInt(procedureId));
    if (procedure) {
        fillEditForm(procedure);
    } else {
        alert('절차서 정보를 찾을 수 없습니다.');
    }
}

function fillEditForm(procedure) {
    document.getElementById('editProcedureId').value = procedure.id;
    document.getElementById('editTitle').value = procedure.title;
    document.getElementById('editVersion').value = procedure.version;
    document.getElementById('editCreatedBy').value = procedure.created_by;
    document.getElementById('editReviewDate').value = procedure.review_date;
    document.getElementById('editStatus').value = procedure.status;
    document.getElementById('editDescription').value = procedure.description || '';
    document.getElementById('editProcedureLink').value = procedure.procedure_link || '';
    document.getElementById('editRiskAssessmentLink').value = procedure.risk_assessment_link || '';
    
    new bootstrap.Modal(document.getElementById('editProcedureModal')).show();
}

// Year filter
document.getElementById('yearFilter').addEventListener('change', function() {
    const selectedYear = this.value;
    const tableRows = document.querySelectorAll('#proceduresTable tbody tr');
    
    tableRows.forEach(row => {
        const yearCell = row.cells[2]; // 버전(연도) 열
        const yearText = yearCell.textContent.trim();
        const year = yearText.replace('년', '');
        
        if (selectedYear === '' || year === selectedYear) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// 절차서 삭제 기능
// 삭제 버튼 클릭 시 확인 후 삭제 요청

document.addEventListener('DOMContentLoaded', function() {
    const deleteBtn = document.getElementById('deleteProcedureBtn');
    if (deleteBtn) {
        deleteBtn.onclick = function() {
            const procedureId = document.getElementById('editProcedureId').value;
            if (!procedureId) {
                alert('삭제할 절차서 ID를 찾을 수 없습니다.');
                return;
            }
            if (confirm('정말로 이 절차서를 삭제하시겠습니까?')) {
                fetch(`/safety/procedures/delete/${procedureId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({})
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('절차서가 삭제되었습니다.');
                        location.reload();
                    } else {
                        alert('삭제 중 오류: ' + (data.message || '')); 
                    }
                })
                .catch(err => {
                    alert('삭제 요청 중 오류 발생: ' + err);
                });
            }
        };
    }
});
</script>
{% endblock %}
