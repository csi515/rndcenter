{% extends "base.html" %}

{% block title %}주간 일정 - R&D 센터 관리시스템{% endblock %}

{% block extra_css %}
<style>
#scheduleTable {
    font-size: 1rem;
    color: #222;
    background: #f5f7fa;
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
}
#scheduleTable th, #scheduleTable td {
    border-radius: 0 !important;
}
#scheduleTable th {
    background: #e3f2fd;
    color: #1976d2;
    font-size: 1.05em;
    border-bottom: 2px solid #90caf9;
    letter-spacing: 0.02em;
}
#scheduleTable td {
    background: #fff;
    border: 1px solid #e3e3e3;
    min-height: 110px;
    max-width: 160px;
    font-size: 0.98em;
    border-radius: 10px;
    box-shadow: 0 1px 4px rgba(33,150,243,0.04);
    transition: box-shadow 0.2s;
}
#scheduleTable td.schedule-cell {
    background: #f8fafc;
    border-radius: 12px;
    box-shadow: 0 1px 6px rgba(33,150,243,0.06);
    min-height: 110px;
    vertical-align: top;
    padding: 10px 6px 6px 6px;
}
#scheduleTable td.schedule-cell:hover {
    background: #e1f5fe !important;
    box-shadow: 0 2px 12px rgba(33,150,243,0.13);
}
.schedule-pill {
    display: inline-block;
    background: #e3f2fd;
    color: #1976d2;
    border-radius: 16px;
    padding: 2px 12px;
    margin: 2px 0;
    font-size: 0.95em;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.2s, color 0.2s;
    border: 1px solid #90caf9;
    font-weight: 500;
    box-shadow: 0 1px 3px rgba(33,150,243,0.07);
}
.schedule-pill:hover {
    background: #bbdefb;
    color: #0d47a1;
}
.schedule-more-pill {
    display: inline-block;
    background: #f8bbd0;
    color: #ad1457;
    border-radius: 16px;
    padding: 2px 12px;
    margin: 2px 0;
    font-size: 0.95em;
    cursor: pointer;
    white-space: nowrap;
    border: 1px solid #f06292;
    font-weight: 500;
    box-shadow: 0 1px 3px rgba(244,143,177,0.07);
}
.btn, .modal-content, .form-control, .form-select {
    border-radius: 1rem !important;
}
.btn-primary, .btn-outline-primary {
    background: linear-gradient(90deg, #1976d2 60%, #64b5f6 100%);
    border: none;
    color: #fff;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(25,118,210,0.08);
}
.btn-primary:hover, .btn-outline-primary:hover {
    background: linear-gradient(90deg, #1565c0 60%, #42a5f5 100%);
    color: #fff;
}
.btn-outline-secondary {
    border: 1.5px solid #bdbdbd;
    color: #616161;
    background: #fff;
    font-weight: 500;
}
.btn-outline-secondary:hover {
    background: #e3f2fd;
    color: #1976d2;
    border-color: #90caf9;
}
.modal-content {
    border-radius: 1.2rem !important;
    box-shadow: 0 4px 24px rgba(25,118,210,0.10);
}
.form-control:focus, .form-select:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 0.15rem rgba(25,118,210,0.13);
}
#currentMonthLabel {
    font-weight: 600;
    color: #1976d2;
    letter-spacing: 0.01em;
    background: #e3f2fd;
    border-radius: 12px;
    padding: 6px 18px;
    box-shadow: 0 1px 4px rgba(33,150,243,0.04);
}
.table-responsive {
    border-radius: 18px;
    background: #f5f7fa;
    padding: 12px 8px 18px 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-calendar-week"></i> 주간 일정</h2>
            <button class="btn btn-primary" id="openProjectListModalBtn">
                <i class="fas fa-cog"></i> 프로젝트 관리
            </button>
        </div>
    </div>
</div>

<!-- 월 네비게이션 -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <button class="btn btn-outline-secondary" id="prevMonthBtn">
                        <i class="fas fa-chevron-left"></i> 이전 달
                    </button>
    <h4 id="currentMonthLabel">2025년 6월 - 8월</h4>
    <button class="btn btn-outline-secondary" id="nextMonthBtn">
                        다음 달 <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

<!-- 주간 일정 표 -->
<div class="table-responsive">
    <table class="table table-bordered" id="scheduleTable">
        <thead id="tableHeader">
            <tr>
                <th>프로젝트명</th>
                <!-- 월/주차 헤더는 JS로 동적 생성 -->
            </tr>
        </thead>
        <tbody>
            <!-- JS로 동적 생성 -->
        </tbody>
    </table>
</div>

<!-- Add Schedule Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addScheduleForm">
                <div class="modal-header">
                    <h5 class="modal-title">일정 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="scheduleId" name="id">
                    <div class="mb-3">
                        <label class="form-label">프로젝트 *</label>
                        <input type="text" class="form-control" id="scheduleProject" name="project" required placeholder="프로젝트명을 입력하세요">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">연도 *</label>
                        <select class="form-select" id="scheduleYear" name="year" required>
                            <!-- JS로 동적 생성 -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">월 *</label>
                        <select class="form-select" id="scheduleMonth" name="month" required>
                            <!-- JS로 동적 생성 -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">주차 *</label>
                        <select class="form-select" id="scheduleWeek" name="week" multiple required>
                            <option value="1">1주차</option>
                            <option value="2">2주차</option>
                            <option value="3">3주차</option>
                            <option value="4">4주차</option>
                        </select>
                        <div class="form-text">Ctrl(또는 Shift) 키로 여러 주를 선택할 수 있습니다.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">작업 내용 *</label>
                        <input type="text" class="form-control" id="scheduleTask" name="task" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">연구원</label>
                        <input type="text" class="form-control" id="scheduleResearcher" name="researcher">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">우선순위</label>
                        <select class="form-select" id="schedulePriority" name="priority">
                            <option value="낮음">낮음</option>
                            <option value="보통" selected>보통</option>
                            <option value="높음">높음</option>
                            <option value="긴급">긴급</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">메모</label>
                        <textarea class="form-control" id="scheduleNotes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteScheduleBtn" style="display: none;">삭제</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary" id="saveScheduleBtn">추가</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editScheduleForm">
                <div class="modal-header">
                    <h5 class="modal-title">일정 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editScheduleId" name="id">
                    <input type="hidden" id="editScheduleWeek" name="week">
                    <div class="mb-3">
                        <label class="form-label">작업 내용 *</label>
                        <input type="text" class="form-control" id="editScheduleTask" name="task" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">연구원</label>
                        <input type="text" class="form-control" id="editScheduleResearcher" name="researcher">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">프로젝트</label>
                        <input type="text" class="form-control" id="editScheduleProject" name="project">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">우선순위</label>
                        <select class="form-select" id="editSchedulePriority" name="priority">
                            <option value="낮음">낮음</option>
                            <option value="보통">보통</option>
                            <option value="높음">높음</option>
                            <option value="긴급">긴급</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">메모</label>
                        <textarea class="form-control" id="editScheduleNotes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteScheduleBtn">삭제</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">수정</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 일정 상세/수정/삭제 모달 -->
<div class="modal fade" id="taskDetailModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">일정 상세</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="taskDetailBody">
        <!-- JS로 내용 채움 -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="deleteTaskBtn">삭제</button>
        <button type="button" class="btn btn-primary" id="editTaskBtn">수정</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>
<!-- 전체 일정 목록 모달 -->
<div class="modal fade" id="allTasksModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">전체 일정 목록</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="allTasksBody">
        <!-- JS로 내용 채움 -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 프로젝트 관리 모달 -->
<div class="modal fade" id="projectManageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">프로젝트 관리</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="projectManageForm">
          <input type="hidden" id="manageProjectNameOld">
          <div class="mb-3">
            <label class="form-label">프로젝트명</label>
            <input type="text" class="form-control" id="manageProjectName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">색상</label>
            <input type="color" class="form-control form-control-color" id="manageProjectColor" value="#1976d2" title="색상 선택">
          </div>
        </form>
        <div class="alert alert-danger d-none" id="projectDeleteWarning">이 프로젝트를 삭제하면 모든 일정이 삭제됩니다.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="deleteProjectBtn">프로젝트 삭제</button>
        <button type="button" class="btn btn-primary" id="saveProjectBtn">저장</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 일정 추가/수정 모달(간결 버전) -->
<div class="modal fade" id="simpleScheduleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="simpleScheduleModalTitle">일정 추가</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="simpleScheduleForm">
          <input type="hidden" id="simpleScheduleId">
          <input type="hidden" id="simpleScheduleProject">
          <input type="hidden" id="simpleScheduleYear">
          <input type="hidden" id="simpleScheduleMonth">
          <input type="hidden" id="simpleScheduleWeek">
          <div class="mb-3">
            <label class="form-label">제목 *</label>
            <input type="text" class="form-control" id="simpleScheduleTitle" required>
          </div>
          <div class="mb-3">
            <label class="form-label">설명</label>
            <textarea class="form-control" id="simpleScheduleDesc" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger d-none" id="simpleScheduleDeleteBtn">삭제</button>
        <button type="button" class="btn btn-primary" id="simpleScheduleSaveBtn">저장</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
      </div>
    </div>
  </div>
</div>

<!-- 프로젝트 목록/추가 모달 -->
<div class="modal fade" id="projectListModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">프로젝트 목록 및 추가</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group mb-3" id="projectListUl">
          <!-- JS로 프로젝트 목록 렌더링 -->
        </ul>
        <form id="addProjectForm">
          <div class="input-group">
            <input type="text" class="form-control" id="newProjectTitle" placeholder="새 프로젝트 제목" required>
            <button class="btn btn-primary" type="submit">추가</button>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 프로젝트 목록 및 일정 데이터 불러오기
let projects = [];
let scheduleData = [];
let currentStartMonth = 6; // 시작 월 (6월부터)
let currentYear = 2025;

// 프로젝트 목록 불러오기 및 테이블 렌더링
function loadProjectsAndRenderTable() {
  fetch('/research/projects/api')
    .then(res => res.json())
    .then(data => {
      projects = data;
      updateTableHeader();
      renderScheduleTable();
      fillProjectSelect();
    })
    .catch(error => {
      console.error('Error loading projects:', error);
    });
}

// 연도 옵션 동적 생성
function updateYearOptions() {
  const yearSelect = document.getElementById('scheduleYear');
  yearSelect.innerHTML = '';
  const thisYear = new Date().getFullYear();
  for (let y = thisYear - 1; y <= thisYear + 3; y++) {
    const option = document.createElement('option');
    option.value = y;
    option.textContent = `${y}년`;
    yearSelect.appendChild(option);
  }
}

// 월 옵션 동적 생성
function updateMonthOptions() {
  const monthSelect = document.getElementById('scheduleMonth');
  monthSelect.innerHTML = '';
  for (let month = 1; month <= 12; month++) {
    const option = document.createElement('option');
    option.value = month;
    option.textContent = `${month}월`;
    monthSelect.appendChild(option);
  }
}

// 테이블 헤더 업데이트
function updateTableHeader() {
  const headerRow = document.querySelector('#tableHeader tr');
  while (headerRow.children.length > 1) {
    headerRow.removeChild(headerRow.lastChild);
  }
  for (let i = 0; i < 3; i++) {
    const month = currentStartMonth + i;
    const displayMonth = month > 12 ? month - 12 : month;
    const year = month > 12 ? currentYear + 1 : currentYear;
    for (let week = 1; week <= 4; week++) {
      const th = document.createElement('th');
      th.textContent = `${displayMonth}월 ${week}주`;
      headerRow.appendChild(th);
    }
  }
  // 월 라벨 업데이트
  const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
  const startMonthName = monthNames[currentStartMonth - 1];
  const endMonth = currentStartMonth + 2;
  const endMonthName = monthNames[(endMonth > 12 ? endMonth - 12 : endMonth) - 1];
  document.getElementById('currentMonthLabel').textContent = `${currentYear}년 ${startMonthName} - ${endMonthName}`;
  updateYearOptions();
  updateMonthOptions();
}

// 프로젝트 입력란은 이제 텍스트 입력이므로 이 함수는 불필요
function fillProjectSelect() {
  // 더 이상 필요 없음 - 직접 입력으로 변경
}

// 일정 데이터 불러오기 (월/주차별)
function loadScheduleData() {
  return fetch('/research/api/schedule')
    .then(res => res.json())
    .then(data => {
      scheduleData = data;
      return data;
    })
    .catch(error => {
      console.error('Error loading schedule data:', error);
      return [];
    });
}

function loadScheduleDataAndRender() {
  loadScheduleData().then(() => {
    renderScheduleTable();
  });
}

// 표 렌더링
function renderScheduleTable() {
  const tbody = document.querySelector('#scheduleTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  // 1. 프로젝트명: projects.csv + schedule.json의 project_name을 합쳐 중복 없이
  const csvProjects = projects.map(p => p.name);
  const scheduleProjects = scheduleData.map(ev => ev.extendedProps && ev.extendedProps.project).filter(Boolean);
  const uniqueProjects = Array.from(new Set([...csvProjects, ...scheduleProjects]));

  uniqueProjects.forEach(projectName => {
    let tr = document.createElement('tr');
    let tdName = document.createElement('td');
    tdName.textContent = projectName;
    tr.appendChild(tdName);

    for (let i = 0; i < 3; i++) {
      const month = currentStartMonth + i;
      const displayMonth = month > 12 ? month - 12 : month;
      const year = month > 12 ? currentYear + 1 : currentYear;
      for (let w = 1; w <= 4; w++) {
        let td = document.createElement('td');
        td.classList.add('schedule-cell');
        td.style.cursor = 'pointer';
        td.style.minHeight = '40px';
        td.style.border = '1px solid #dee2e6';
        td.dataset.project = projectName;
        td.dataset.month = displayMonth;
        td.dataset.week = w;
        td.dataset.year = year;

        // 해당 셀에 표시할 일정들 찾기
        const foundList = scheduleData.filter(ev => {
          if (!ev.extendedProps || ev.extendedProps.project !== projectName) return false;
          const y = ev.extendedProps.year || year;
          const m = ev.extendedProps.month || displayMonth;
          const wk = ev.extendedProps.week || w;
          return String(y) == String(year) && String(m) == String(displayMonth) && String(wk) == String(w);
        });

        // 일정 pill 렌더링 (최대 6개, 초과 시 +N개 더보기)
        if (foundList.length > 0) {
          let pills = '';
          const maxShow = 6;
          foundList.slice(0, maxShow).forEach((found, idx) => {
            let taskTitle = found.title;
            if (typeof taskTitle === 'string' && taskTitle.includes(' - ')) {
              const parts = taskTitle.split(' - ');
              taskTitle = parts.length > 1 ? parts.slice(1).join(' - ') : parts[0];
            }
            pills += `<span class=\"schedule-pill\" data-id=\"${found.id}\" data-project=\"${projectName}\" data-month=\"${displayMonth}\" data-week=\"${w}\">${taskTitle}</span><br/>`;
          });
          if (foundList.length > maxShow) {
            const more = foundList.length - maxShow;
            pills += `<span class=\"schedule-more-pill\" data-project=\"${projectName}\" data-month=\"${displayMonth}\" data-week=\"${w}\">+${more}개 더보기</span>`;
          }
          td.innerHTML = pills;
        } else {
          td.innerHTML = '';
          td.style.backgroundColor = '';
          td.style.border = '1px solid #dee2e6';
          td.classList.remove('has-schedule');
        }
        tr.appendChild(td);
      }
    }
    tbody.appendChild(tr);
  });
}

// 모달 오픈 및 값 세팅
function openAddScheduleModal(project, month, week, task, researcher, mode, id, priority, notes) {
  updateYearOptions();
  updateMonthOptions();
  document.getElementById('scheduleId').value = id || '';
  document.getElementById('scheduleProject').value = project;
  // month, week가 없으면 현재 월/주차로 기본값
  const now = new Date();
  document.getElementById('scheduleYear').value = (typeof currentYear !== 'undefined' ? currentYear : now.getFullYear());
  document.getElementById('scheduleMonth').value = month || (now.getMonth() + 1);
  document.getElementById('scheduleWeek').value = week || 1;
  document.getElementById('scheduleTask').value = task || '';
  document.getElementById('scheduleResearcher').value = researcher || '';
  document.getElementById('schedulePriority').value = priority || '보통';
  document.getElementById('scheduleNotes').value = notes || '';
  document.getElementById('saveScheduleBtn').textContent = (mode === 'edit') ? '수정' : '추가';
  document.getElementById('deleteScheduleBtn').style.display = (mode === 'edit') ? 'inline-block' : 'none';
  document.querySelector('#addScheduleModal .modal-title').textContent = (mode === 'edit') ? '일정 수정' : '일정 추가';
  new bootstrap.Modal(document.getElementById('addScheduleModal')).show();
}

// 수정 모달 오픈
function editSchedule(event, id, project, month, week, task, researcher, priority, notes, year) {
  event.stopPropagation();
  updateYearOptions();
  updateMonthOptions();
  document.getElementById('scheduleId').value = id;
  document.getElementById('scheduleProject').value = project;
  document.getElementById('scheduleYear').value = year || currentYear;
  document.getElementById('scheduleMonth').value = month;
  document.getElementById('scheduleWeek').value = week;
  document.getElementById('scheduleTask').value = task;
  document.getElementById('scheduleResearcher').value = researcher;
  document.getElementById('schedulePriority').value = priority;
  document.getElementById('scheduleNotes').value = notes;
  document.getElementById('saveScheduleBtn').textContent = '수정';
  document.getElementById('deleteScheduleBtn').style.display = 'inline-block';
  document.querySelector('#addScheduleModal .modal-title').textContent = '일정 수정';
  new bootstrap.Modal(document.getElementById('addScheduleModal')).show();
}

// 삭제 함수
function deleteSchedule(event, id) {
  event.stopPropagation();
  
  if (confirm('정말로 이 일정을 삭제하시겠습니까?')) {
    fetch(`/research/schedule/delete/${id}`, {
      method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('일정이 삭제되었습니다.');
        loadScheduleDataAndRender();
      } else {
        alert('삭제 중 오류가 발생했습니다: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
      alert('삭제 중 오류가 발생했습니다.');
    });
  }
}

// 월 네비게이션 이벤트
function initializeNavigation() {
  document.getElementById('prevMonthBtn').addEventListener('click', function() {
    currentStartMonth -= 1;
    if (currentStartMonth <= 0) {
      currentStartMonth += 12;
      currentYear--;
    }
    updateTableHeader();
    renderScheduleTable();
  });

  document.getElementById('nextMonthBtn').addEventListener('click', function() {
    currentStartMonth += 1;
    if (currentStartMonth > 12) {
      currentStartMonth -= 12;
      currentYear++;
    }
    updateTableHeader();
    renderScheduleTable();
  });
}

// 폼 제출 시 일정 추가/수정
document.addEventListener('DOMContentLoaded', function() {
  const addScheduleForm = document.getElementById('addScheduleForm');
  if (addScheduleForm) {
    addScheduleForm.addEventListener('submit', function(e) {
    e.preventDefault();
      const formData = new FormData(addScheduleForm);
      const scheduleId = formData.get('id');
      const year = formData.get('year');
      const month = formData.get('month');
      const week = formData.get('week');
      const startDate = `${year}-${month.padStart(2, '0')}-${(parseInt(week) * 7).toString().padStart(2, '0')}`;
      const endDate = startDate;
      formData.set('project_name', formData.get('project'));
      formData.set('start_date', startDate);
      formData.set('end_date', endDate);
      formData.set('start_time', '09:00');
      formData.set('end_time', '18:00');
      formData.set('researcher_name', formData.get('researcher') || '');
      formData.set('year', year);
      const url = scheduleId ? `/research/schedule/update/${scheduleId}` : '/research/schedule/add';
      const method = scheduleId ? 'PUT' : 'POST';
      fetch(url, {
        method: method,
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          loadScheduleDataAndRender();
            bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
          addScheduleForm.reset();
          alert(scheduleId ? '일정이 성공적으로 수정되었습니다.' : '일정이 성공적으로 추가되었습니다.');
        } else {
          alert((scheduleId ? '일정 수정' : '일정 추가') + ' 중 오류가 발생했습니다: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert((scheduleId ? '일정 수정' : '일정 추가') + ' 중 오류가 발생했습니다.');
      });
    });
  }
  
  // 삭제 버튼 이벤트
  const deleteBtn = document.getElementById('deleteScheduleBtn');
  if (deleteBtn) {
    deleteBtn.addEventListener('click', function() {
      const scheduleId = document.getElementById('scheduleId').value;
      if (scheduleId) {
        deleteSchedule({stopPropagation: () => {}}, scheduleId);
        bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
        }
    });
}

  // 초기 데이터 로드
  initializeNavigation();
  updateMonthOptions(); // 페이지 로드 시 월 옵션 초기화
  // 먼저 일정 데이터를 로드한 후 프로젝트와 테이블을 렌더링
  loadScheduleData().then(() => {
    loadProjectsAndRenderTable();
  });

  // 일정 pill 클릭 이벤트 위임 (DOMContentLoaded 내에 추가)
  document.querySelector('#scheduleTable').addEventListener('click', function(e) {
    if (e.target.classList.contains('schedule-pill')) {
      const id = e.target.dataset.id;
      showTaskDetailModal(id);
      e.stopPropagation();
      return;
    }
    if (e.target.classList.contains('schedule-more-pill')) return;
    // 셀 클릭: pill이 아닌 부분 클릭 시 추가 팝업
    const td = e.target.closest('.schedule-cell');
    if (!td) return;
    // pill 클릭이 아니면 무조건 추가 팝업
    openSimpleScheduleModal({
      mode: 'add',
      project: td.dataset.project,
      year: td.dataset.year,
      month: td.dataset.month,
      week: td.dataset.week
    });
  });
});

// editProjectSchedules, deleteProjectSchedules 함수 추가
function editProjectSchedules(projectName) {
  const found = scheduleData.find(ev => ev.extendedProps && ev.extendedProps.project === projectName);
  if (found) {
    const task = found.title.split(' - ')[1] || found.title;
    const researcher = found.title.split(' - ')[0] || '';
    const priority = found.extendedProps.priority || '보통';
    const notes = found.extendedProps.notes || '';
    const year = found.extendedProps.year || currentYear;
    const month = found.extendedProps.month || currentStartMonth;
    const week = found.extendedProps.week || 1;
    openAddScheduleModal(projectName, month, week, task, researcher, 'edit', found.id, priority, notes, year);
  } else {
    alert('해당 프로젝트의 일정이 없습니다.');
  }
}

function deleteProjectSchedules(projectName) {
  if (confirm('정말로 이 프로젝트의 모든 일정을 삭제하시겠습니까?')) {
    const ids = scheduleData
      .filter(ev => ev.extendedProps && ev.extendedProps.project === projectName)
      .map(ev => ev.id);
    Promise.all(ids.map(id =>
      fetch(`/research/schedule/delete/${id}`, { method: 'DELETE' })
    )).then(() => {
      alert('모든 일정이 삭제되었습니다.');
      loadScheduleDataAndRender();
    });
  }
}

// JS: 상세/수정/삭제, 전체 목록 모달 함수 추가 (DOMContentLoaded 내에 추가)
function showTaskDetailModal(id) {
  const task = scheduleData.find(ev => String(ev.id) === String(id));
  if (!task) return;
  let parsedTitle = task.title;
  if (typeof parsedTitle === 'string' && parsedTitle.includes(' - ')) {
    const parts = parsedTitle.split(' - ');
    parsedTitle = parts.length > 1 ? parts.slice(1).join(' - ') : parts[0];
  }
  openSimpleScheduleModal({
    mode: 'edit',
    id: task.id,
    project: task.extendedProps?.project || '',
    year: task.extendedProps?.year || '',
    month: task.extendedProps?.month || '',
    week: task.extendedProps?.week || '',
    title: parsedTitle,
    desc: task.extendedProps?.notes || '',
  });
}

function showAllTasksModal(project, month, week) {
  const list = scheduleData.filter(ev => {
    if (!ev.extendedProps || ev.extendedProps.project !== project) return false;
    const y = ev.extendedProps.year;
    const m = ev.extendedProps.month;
    const wk = ev.extendedProps.week;
    return String(m) == String(month) && String(wk) == String(week);
  });
  const body = document.getElementById('allTasksBody');
  if (list.length === 0) {
    body.innerHTML = '<div class="text-muted">일정이 없습니다.</div>';
  } else {
    body.innerHTML = list.map(task => {
      let taskTitle = task.title;
      if (typeof taskTitle === 'string' && taskTitle.includes(' - ')) {
        const parts = taskTitle.split(' - ');
        taskTitle = parts.length > 1 ? parts.slice(1).join(' - ') : parts[0];
      }
      return `<div class='schedule-pill mb-1' style='display:block;cursor:pointer;' data-id='${task.id}'>${taskTitle}</div>`;
    }).join('');
  }
  new bootstrap.Modal(document.getElementById('allTasksModal')).show();
}

// 전체 목록 모달 내 pill 클릭 시 상세 모달 오픈
  document.getElementById('allTasksBody').addEventListener('click', function(e) {
    if (e.target.classList.contains('schedule-pill')) {
      const id = e.target.dataset.id;
      showTaskDetailModal(id);
    }
  });

// 삭제 버튼 이벤트 연결
  document.getElementById('deleteTaskBtn').addEventListener('click', function() {
    const id = this.dataset.id;
    if (confirm('정말로 이 일정을 삭제하시겠습니까?')) {
      fetch(`/research/schedule/delete/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            loadScheduleDataAndRender();
            bootstrap.Modal.getInstance(document.getElementById('taskDetailModal')).hide();
            alert('일정이 삭제되었습니다.');
          } else {
            alert('삭제 중 오류가 발생했습니다: ' + data.message);
          }
        });
    }
  });

// JS: 관리 버튼을 '⚙ 관리'로 통합, 클릭 시 프로젝트 관리 모달 오픈
function openProjectManageModal(projectName) {
  // 프로젝트 정보 불러오기
  const project = (projects.find(p => p.name === projectName) || {name: projectName, color: '#1976d2'});
  document.getElementById('manageProjectNameOld').value = project.name;
  document.getElementById('manageProjectName').value = project.name;
  document.getElementById('manageProjectColor').value = project.color || '#1976d2';
  document.getElementById('projectDeleteWarning').classList.add('d-none');
  new bootstrap.Modal(document.getElementById('projectManageModal')).show();
}

// 저장 버튼 이벤트
document.getElementById('saveProjectBtn').addEventListener('click', function() {
  const oldName = document.getElementById('manageProjectNameOld').value.trim();
  const newName = document.getElementById('manageProjectName').value.trim();
  const color = document.getElementById('manageProjectColor').value;
  if (!newName) { alert('프로젝트명을 입력하세요.'); return; }
  // oldName이 비어있으면 추가, 있으면 수정
  fetch('/research/projects/manage', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({old_name: oldName, new_name: newName, color: color})
  }).then(res => res.json()).then(data => {
    if (data.success) {
      loadProjectsAndRenderTable();
      bootstrap.Modal.getInstance(document.getElementById('projectManageModal')).hide();
      // 입력란 초기화
      document.getElementById('manageProjectNameOld').value = '';
      document.getElementById('manageProjectName').value = '';
      document.getElementById('manageProjectColor').value = '#1976d2';
      alert('프로젝트 정보가 저장되었습니다.');
    } else {
      alert('저장 중 오류: ' + data.message);
    }
  });
});

// 삭제 버튼 이벤트
document.getElementById('deleteProjectBtn').addEventListener('click', function() {
  document.getElementById('projectDeleteWarning').classList.remove('d-none');
  if (confirm('정말로 이 프로젝트와 모든 일정을 삭제하시겠습니까?')) {
    const name = document.getElementById('manageProjectNameOld').value;
    fetch('/research/projects/delete', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name: name})
    }).then(res => res.json()).then(data => {
      if (data.success) {
        loadProjectsAndRenderTable();
        bootstrap.Modal.getInstance(document.getElementById('projectManageModal')).hide();
        alert('프로젝트가 삭제되었습니다.');
      } else {
        alert('삭제 중 오류: ' + data.message);
      }
    });
  }
});

// 일정 추가/수정 모달 제어 함수
function openSimpleScheduleModal({mode, id, project, year, month, week, title, desc}) {
  const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
  const modalTitle = (mode === 'edit') ? '일정 변경' : '일정 추가';
  const titleEl = document.getElementById('simpleScheduleModalTitle');
  if (titleEl) titleEl.textContent = modalTitle;
  setVal('simpleScheduleId', id);
  setVal('simpleScheduleProject', project);
  setVal('simpleScheduleTitle', title);
  setVal('simpleScheduleDesc', desc);
  setVal('simpleScheduleYear', year);
  setVal('simpleScheduleMonth', month);
  setVal('simpleScheduleWeek', week);
  setVal('simpleScheduleStart', `${year}년 ${month}월 ${week}주차`);
  const delBtn = document.getElementById('simpleScheduleDeleteBtn');
  if (delBtn) delBtn.classList.toggle('d-none', mode !== 'edit');
  const modal = document.getElementById('simpleScheduleModal');
  if (modal) new bootstrap.Modal(modal).show();
}

// 저장/삭제 버튼 이벤트 (DOMContentLoaded 내에 추가)
document.getElementById('simpleScheduleSaveBtn').onclick = function() {
  const id = document.getElementById('simpleScheduleId').value;
  const project = document.getElementById('simpleScheduleProject').value;
  const title = document.getElementById('simpleScheduleTitle').value.trim();
  const desc = document.getElementById('simpleScheduleDesc').value.trim();
  const year = document.getElementById('simpleScheduleYear').value;
  const month = document.getElementById('simpleScheduleMonth').value;
  const week = document.getElementById('simpleScheduleWeek').value;
  if (!title) { alert('제목을 입력하세요.'); return; }
  const payload = {
    id, project,
    year, month, week,
    task: title,
    notes: desc
  };
  const url = id ? `/research/schedule/update/${id}` : '/research/schedule/add';
  const method = id ? 'PUT' : 'POST';
  fetch(url, {
    method,
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  }).then(res => res.json()).then(data => {
    loadScheduleDataAndRender();
    bootstrap.Modal.getInstance(document.getElementById('simpleScheduleModal')).hide();
    document.activeElement.blur();
    if (data.success) {
      alert('저장되었습니다.');
    } else {
      alert('저장 중 오류: ' + data.message);
    }
  });
};
document.getElementById('simpleScheduleDeleteBtn').onclick = function() {
  const id = document.getElementById('simpleScheduleId').value;
  if (!id) return;
  if (!confirm('정말로 이 일정을 삭제하시겠습니까?')) return;
  fetch(`/research/schedule/delete/${id}`, {method: 'DELETE'}).then(res => res.json()).then(data => {
    loadScheduleDataAndRender();
    bootstrap.Modal.getInstance(document.getElementById('simpleScheduleModal')).hide();
    document.activeElement.blur();
    if (data.success) {
      alert('삭제되었습니다.');
    } else {
      alert('삭제 중 오류: ' + data.message);
    }
  });
};

// JS: 프로젝트 목록 모달 오픈 및 목록 렌더링, 새 프로젝트 추가 (DOMContentLoaded 내에 추가)
document.getElementById('openProjectListModalBtn').onclick = function() {
  renderProjectListUl();
  new bootstrap.Modal(document.getElementById('projectListModal')).show();
};
function renderProjectListUl() {
  const ul = document.getElementById('projectListUl');
  ul.innerHTML = '';
  // projects.csv + schedule.json의 project_name 합치기
  const csvProjects = projects.map(p => p.name);
  const scheduleProjects = scheduleData.map(ev => (ev.extendedProps?.project || ev.project_name)).filter(Boolean);
  const uniqueProjects = Array.from(new Set([...csvProjects, ...scheduleProjects]));
  uniqueProjects.forEach(name => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `
      <span class="project-title" data-name="${name}">${name}</span>
      <span>
        <button class="btn btn-sm btn-outline-secondary me-1 edit-project-btn" data-name="${name}">수정</button>
        <button class="btn btn-sm btn-outline-danger delete-project-btn" data-name="${name}">삭제</button>
      </span>
    `;
    ul.appendChild(li);
  });
}
document.getElementById('addProjectForm').onsubmit = function(e) {
  e.preventDefault();
  const title = document.getElementById('newProjectTitle').value.trim();
  if (!title) return;
  fetch('/research/projects/manage', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({old_name: '', new_name: title, color: '#1976d2'})
  }).then(res => res.json()).then(data => {
    if (data.success) {
      document.getElementById('newProjectTitle').value = '';
      loadProjectsAndRenderTable();
      renderProjectListUl();
    } else {
      alert('추가 실패: ' + data.message);
    }
  });
};

// 수정/삭제 버튼 이벤트 위임 (DOMContentLoaded 내에 추가)
document.getElementById('projectListUl').onclick = function(e) {
  // 수정 버튼 클릭
  if (e.target.classList.contains('edit-project-btn')) {
    const name = e.target.dataset.name;
    const li = e.target.closest('li');
    const span = li.querySelector('.project-title');
    // 인라인 input으로 변경
    const input = document.createElement('input');
    input.type = 'text';
    input.value = name;
    input.className = 'form-control form-control-sm d-inline-block';
    input.style.width = '60%';
    span.replaceWith(input);
    input.focus();
    // 저장/취소 버튼으로 변경
    e.target.textContent = '저장';
    e.target.classList.remove('edit-project-btn','btn-outline-secondary');
    e.target.classList.add('save-project-btn','btn-success');
    // 취소 버튼 추가
    let cancelBtn = li.querySelector('.cancel-edit-btn');
    if (!cancelBtn) {
      cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-sm btn-outline-secondary cancel-edit-btn ms-1';
      cancelBtn.textContent = '취소';
      e.target.parentNode.appendChild(cancelBtn);
    }
  }
  // 저장 버튼 클릭
  else if (e.target.classList.contains('save-project-btn')) {
    const li = e.target.closest('li');
    const input = li.querySelector('input');
    const oldName = e.target.dataset.name;
    const newName = input.value.trim();
    if (!newName) return;
    fetch('/research/projects/manage', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({old_name: oldName, new_name: newName, color: '#1976d2'})
    }).then(res => res.json()).then(data => {
      if (data.success) {
        loadProjectsAndRenderTable();
        renderProjectListUl();
      } else {
        alert('수정 실패: ' + data.message);
      }
    });
  }
  // 취소 버튼 클릭
  else if (e.target.classList.contains('cancel-edit-btn')) {
    renderProjectListUl();
  }
  // 삭제 버튼 클릭
  else if (e.target.classList.contains('delete-project-btn')) {
    const name = e.target.dataset.name;
    if (!confirm('정말로 이 프로젝트와 모든 일정을 삭제하시겠습니까?')) return;
    fetch('/research/projects/delete', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name: name})
    }).then(res => res.json()).then(data => {
      if (data.success) {
        loadProjectsAndRenderTable();
        renderProjectListUl();
      } else {
        alert('삭제 실패: ' + data.message);
      }
    });
  }
};
</script>
{% endblock %}
