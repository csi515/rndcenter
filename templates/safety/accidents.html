{% extends "base.html" %}

{% block title %}사고관리 - R&D 센터 관리시스템{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-exclamation-triangle"></i> 사고관리</h2>
            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addAccidentModal">
                <i class="fas fa-plus"></i> 사고 보고
            </button>
        </div>
    </div>
</div>

<!-- 사고 목록 테이블 -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">사고 보고서 목록</h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="loadAccidents()">
            <i class="fas fa-sync-alt"></i> 새로고침
        </button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle" id="accidentsTable">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 12%;">발생일시</th>
                        <th style="width: 15%;">발생장소</th>
                        <th style="width: 25%;">사고 내용</th>
                        <th style="width: 8%;">심각도</th>
                        <th style="width: 12%;">관련자</th>
                        <th style="width: 8%;">상태</th>
                        <th style="width: 12%;">보고자</th>
                        <th style="width: 8%;">작업</th>
                    </tr>
                </thead>
                <tbody id="accidentsTableBody">
                    <!-- 데이터가 여기에 동적으로 로드됩니다 -->
                </tbody>
            </table>
        </div>
        
        <!-- 빈 상태 메시지 -->
        <div id="emptyMessage" class="text-center py-5 d-none">
            <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">등록된 사고 보고서가 없습니다</h5>
            <p class="text-muted">상단 버튼을 통해 새로운 사고를 보고해보세요.</p>
        </div>
    </div>
</div>

<!-- 사고 보고 모달 -->
<div class="modal fade" id="addAccidentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('safety.add_accident') }}">
                <div class="modal-header">
                    <h5 class="modal-title">사고 보고서 작성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">발생일시 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="incident_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">발생장소 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="location" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">심각도 <span class="text-danger">*</span></label>
                            <select class="form-select" name="severity" required>
                                <option value="">선택하세요</option>
                                <option value="경미">경미</option>
                                <option value="보통">보통</option>
                                <option value="심각">심각</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">관련자</label>
                            <input type="text" class="form-control" name="involved_person">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">사고 내용 <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="description" rows="4" required placeholder="사고의 상세한 내용을 기록하세요"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">즉시 조치 사항</label>
                        <textarea class="form-control" name="immediate_action" rows="3" placeholder="즉시 취한 조치사항을 기록하세요"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">후속 조치</label>
                        <textarea class="form-control" name="follow_up" rows="3" placeholder="후속 조치 계획을 기록하세요"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">예방 대책</label>
                        <textarea class="form-control" name="prevention" rows="3" placeholder="향후 동일한 사고 방지를 위한 대책을 기록하세요"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">처리 상태</label>
                            <select class="form-select" name="status">
                                <option value="조사중">조사중</option>
                                <option value="진행중">진행중</option>
                                <option value="완료">완료</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">보고자 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="reporter" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-danger">보고서 제출</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 사고 상세보기 모달 -->
<div class="modal fade" id="viewAccidentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">사고 보고서 상세</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="accidentDetails"></div>
                
                <!-- 관련 자료 섹션 -->
                <hr class="my-4">
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-paperclip"></i> 관련 자료</h6>
                        
                        <!-- 자료 추가 폼 -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <form id="addDocumentForm">
                                    <input type="hidden" id="currentAccidentId">
                                    <div class="row g-2">
                                        <div class="col-md-5">
                                            <input type="text" class="form-control" id="documentTitle" name="title" placeholder="자료 제목" required>
                                        </div>
                                        <div class="col-md-5">
                                            <input type="url" class="form-control" id="documentUrl" name="url" placeholder="https://..." required>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fas fa-plus"></i> 추가
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- 자료 목록 -->
                        <div id="documentsContainer">
                            <!-- 자료 목록이 여기에 동적으로 로드됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="printAccident()">
                    <i class="fas fa-print"></i> 인쇄
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentAccidents = [];
let editingRow = null;

// 페이지 로드 시 사고 목록 불러오기
document.addEventListener('DOMContentLoaded', function() {
    loadAccidents();
    
    // 자료 추가 폼 이벤트 리스너
    document.getElementById('addDocumentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addDocument();
    });
});

// 사고 목록 로드
function loadAccidents() {
    console.log('사고 목록 로드 시작');
    
    fetch('/safety/api/accidents')
        .then(response => response.json())
        .then(data => {
            console.log('사고 API 응답:', data);
            
            if (data.success) {
                currentAccidents = data.accidents;
                renderAccidentsTable(data.accidents);
            } else {
                console.error('사고 로드 실패:', data.message);
                showNotification(data.message || '사고 목록을 불러오는 중 오류가 발생했습니다.', 'danger');
            }
        })
        .catch(error => {
            console.error('사고 로드 오류:', error);
            showNotification('사고 목록을 불러오는 중 오류가 발생했습니다.', 'danger');
        });
}

// 테이블 렌더링
function renderAccidentsTable(accidents) {
    const tbody = document.getElementById('accidentsTableBody');
    const emptyMessage = document.getElementById('emptyMessage');
    
    if (!accidents || accidents.length === 0) {
        tbody.innerHTML = '';
        emptyMessage.classList.remove('d-none');
        return;
    }
    
    emptyMessage.classList.add('d-none');
    
    tbody.innerHTML = accidents.map(accident => {
        const severityClass = accident.severity === '경미' ? 'success' : accident.severity === '보통' ? 'warning' : 'danger';
        const statusClass = accident.status === '완료' ? 'success' : accident.status === '진행중' ? 'warning' : 'info';
        
        return `
            <tr id="row-${accident.id}" data-accident-id="${accident.id}">
                <td class="editable" data-field="incident_date">${escapeHtml(accident.incident_date)}</td>
                <td class="editable" data-field="location">${escapeHtml(accident.location)}</td>
                <td class="editable" data-field="description">
                    <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(accident.description)}">
                        ${escapeHtml(accident.description)}
                    </div>
                </td>
                <td class="editable" data-field="severity">
                    <span class="badge bg-${severityClass}">${escapeHtml(accident.severity)}</span>
                </td>
                <td class="editable" data-field="involved_person">${escapeHtml(accident.involved_person)}</td>
                <td class="editable" data-field="status">
                    <span class="badge bg-${statusClass}">${escapeHtml(accident.status)}</span>
                </td>
                <td class="editable" data-field="reporter">${escapeHtml(accident.reporter)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-info" onclick="viewAccident(${accident.id})" title="상세보기">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="editAccident(${accident.id})" title="수정">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteAccident(${accident.id})" title="삭제">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// 사고 상세보기
function viewAccident(accidentId) {
    const accident = currentAccidents.find(a => a.id === accidentId);
    if (!accident) return;
    
    const severityClass = accident.severity === '경미' ? 'success' : accident.severity === '보통' ? 'warning' : 'danger';
    const statusClass = accident.status === '완료' ? 'success' : accident.status === '진행중' ? 'warning' : 'info';
    
    const details = `
        <div class="row g-3">
            <div class="col-md-6">
                <strong>발생일시:</strong><br>
                <span class="text-muted">${escapeHtml(accident.incident_date)}</span>
            </div>
            <div class="col-md-6">
                <strong>발생장소:</strong><br>
                <span class="text-muted">${escapeHtml(accident.location)}</span>
            </div>
            <div class="col-md-6">
                <strong>심각도:</strong><br>
                <span class="badge bg-${severityClass}">${escapeHtml(accident.severity)}</span>
            </div>
            <div class="col-md-6">
                <strong>관련자:</strong><br>
                <span class="text-muted">${escapeHtml(accident.involved_person || '없음')}</span>
            </div>
            <div class="col-md-6">
                <strong>상태:</strong><br>
                <span class="badge bg-${statusClass}">${escapeHtml(accident.status)}</span>
            </div>
            <div class="col-md-6">
                <strong>보고자:</strong><br>
                <span class="text-muted">${escapeHtml(accident.reporter)}</span>
            </div>
            <div class="col-12">
                <strong>사고 내용:</strong><br>
                <div class="border p-3 bg-light mt-2">${escapeHtml(accident.description)}</div>
            </div>
            <div class="col-12">
                <strong>즉시 조치 사항:</strong><br>
                <div class="border p-3 bg-light mt-2">${escapeHtml(accident.immediate_action || '미입력')}</div>
            </div>
            <div class="col-12">
                <strong>후속 조치:</strong><br>
                <div class="border p-3 bg-light mt-2">${escapeHtml(accident.follow_up || '미입력')}</div>
            </div>
            <div class="col-12">
                <strong>예방 대책:</strong><br>
                <div class="border p-3 bg-light mt-2">${escapeHtml(accident.prevention || '미입력')}</div>
            </div>
        </div>
    `;
    
    document.getElementById('accidentDetails').innerHTML = details;
    document.getElementById('currentAccidentId').value = accidentId;
    
    // 관련 자료 로드
    loadDocuments(accident.documents || []);
    
    new bootstrap.Modal(document.getElementById('viewAccidentModal')).show();
}

// 관련 자료 로드
function loadDocuments(documents) {
    const container = document.getElementById('documentsContainer');
    
    if (!documents || documents.length === 0) {
        container.innerHTML = '<p class="text-muted">등록된 관련 자료가 없습니다.</p>';
        return;
    }
    
    container.innerHTML = documents.map(doc => `
        <div class="d-flex justify-content-between align-items-center border p-3 mb-2 bg-white rounded">
            <div>
                <strong>${escapeHtml(doc.title)}</strong><br>
                <a href="${escapeHtml(doc.url)}" target="_blank" class="text-primary">
                    <i class="fas fa-external-link-alt"></i> ${escapeHtml(doc.url)}
                </a>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteDocument(${doc.id})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `).join('');
}

// 관련 자료 추가
function addDocument() {
    const accidentId = document.getElementById('currentAccidentId').value;
    const form = document.getElementById('addDocumentForm');
    const formData = new FormData(form);
    
    console.log('관련 자료 추가:', accidentId);
    
    fetch(`/safety/api/accidents/${accidentId}/documents`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('자료 추가 응답:', data);
        
        if (data.success) {
            showNotification(data.message || '관련 자료가 성공적으로 추가되었습니다.', 'success');
            form.reset();
            
            // 사고 목록 새로고침하여 최신 자료 포함
            loadAccidents();
            
            // 현재 보고 있는 사고의 자료 목록 업데이트
            const currentAccident = currentAccidents.find(a => a.id == accidentId);
            if (currentAccident && data.document) {
                currentAccident.documents = currentAccident.documents || [];
                currentAccident.documents.push(data.document);
                loadDocuments(currentAccident.documents);
            }
        } else {
            showNotification(data.message || '관련 자료 추가 중 오류가 발생했습니다.', 'danger');
        }
    })
    .catch(error => {
        console.error('자료 추가 오류:', error);
        showNotification('관련 자료 추가 중 오류가 발생했습니다.', 'danger');
    });
}

// 관련 자료 삭제
function deleteDocument(documentId) {
    if (!confirm('이 관련 자료를 삭제하시겠습니까?')) {
        return;
    }
    
    const accidentId = document.getElementById('currentAccidentId').value;
    
    console.log('관련 자료 삭제:', documentId);
    
    fetch(`/safety/api/accidents/${accidentId}/documents/${documentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        console.log('자료 삭제 응답:', data);
        
        if (data.success) {
            showNotification(data.message || '관련 자료가 성공적으로 삭제되었습니다.', 'success');
            
            // 사고 목록 새로고침
            loadAccidents();
            
            // 현재 보고 있는 사고의 자료 목록 업데이트
            const currentAccident = currentAccidents.find(a => a.id == accidentId);
            if (currentAccident && currentAccident.documents) {
                currentAccident.documents = currentAccident.documents.filter(doc => doc.id !== documentId);
                loadDocuments(currentAccident.documents);
            }
        } else {
            showNotification(data.message || '관련 자료 삭제 중 오류가 발생했습니다.', 'danger');
        }
    })
    .catch(error => {
        console.error('자료 삭제 오류:', error);
        showNotification('관련 자료 삭제 중 오류가 발생했습니다.', 'danger');
    });
}

// 인라인 편집 시작
function editAccident(accidentId) {
    if (editingRow !== null) {
        showNotification('이미 편집 중인 항목이 있습니다. 먼저 저장하거나 취소해주세요.', 'warning');
        return;
    }
    
    const accident = currentAccidents.find(a => a.id === accidentId);
    if (!accident) return;
    
    editingRow = accidentId;
    const row = document.getElementById(`row-${accidentId}`);
    const cells = row.querySelectorAll('.editable');
    
    cells.forEach(cell => {
        const field = cell.dataset.field;
        const currentValue = getFieldValue(accident, field);
        
        if (field === 'severity') {
            cell.innerHTML = `
                <select class="form-select form-select-sm">
                    <option value="경미" ${currentValue === '경미' ? 'selected' : ''}>경미</option>
                    <option value="보통" ${currentValue === '보통' ? 'selected' : ''}>보통</option>
                    <option value="심각" ${currentValue === '심각' ? 'selected' : ''}>심각</option>
                </select>
            `;
        } else if (field === 'status') {
            cell.innerHTML = `
                <select class="form-select form-select-sm">
                    <option value="조사중" ${currentValue === '조사중' ? 'selected' : ''}>조사중</option>
                    <option value="진행중" ${currentValue === '진행중' ? 'selected' : ''}>진행중</option>
                    <option value="완료" ${currentValue === '완료' ? 'selected' : ''}>완료</option>
                </select>
            `;
        } else if (field === 'incident_date') {
            cell.innerHTML = `<input type="date" class="form-control form-control-sm" value="${currentValue}">`;
        } else if (field === 'description') {
            cell.innerHTML = `<textarea class="form-control form-control-sm" rows="2">${escapeHtml(currentValue)}</textarea>`;
        } else {
            cell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${escapeHtml(currentValue)}">`;
        }
    });
    
    // 작업 버튼 변경
    const actionCell = row.querySelector('td:last-child');
    actionCell.innerHTML = `
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-success" onclick="saveAccident(${accidentId})" title="저장">
                <i class="fas fa-save"></i>
            </button>
            <button type="button" class="btn btn-secondary" onclick="cancelEdit(${accidentId})" title="취소">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
}

// 편집 취소
function cancelEdit(accidentId) {
    editingRow = null;
    loadAccidents(); // 테이블 다시 로드하여 원래 상태로 복원
}

// 사고 정보 저장
function saveAccident(accidentId) {
    const row = document.getElementById(`row-${accidentId}`);
    const cells = row.querySelectorAll('.editable');
    const formData = new FormData();
    
    cells.forEach(cell => {
        const field = cell.dataset.field;
        let value = '';
        
        const input = cell.querySelector('input, select, textarea');
        if (input) {
            value = input.value;
        }
        
        formData.append(field, value);
    });
    
    console.log('사고 정보 저장:', accidentId);
    
    fetch(`/safety/api/accidents/${accidentId}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('사고 수정 응답:', data);
        
        if (data.success) {
            showNotification(data.message || '사고 정보가 성공적으로 수정되었습니다.', 'success');
            editingRow = null;
            loadAccidents();
        } else {
            showNotification(data.message || '사고 정보 수정 중 오류가 발생했습니다.', 'danger');
        }
    })
    .catch(error => {
        console.error('사고 수정 오류:', error);
        showNotification('사고 정보 수정 중 오류가 발생했습니다.', 'danger');
    });
}

// 사고 삭제
function deleteAccident(accidentId) {
    if (!confirm('이 사고 보고서를 삭제하시겠습니까?\n관련된 모든 자료도 함께 삭제됩니다.')) {
        return;
    }
    
    console.log('사고 삭제:', accidentId);
    
    fetch(`/safety/api/accidents/${accidentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        console.log('사고 삭제 응답:', data);
        
        if (data.success) {
            showNotification(data.message || '사고 보고서가 성공적으로 삭제되었습니다.', 'success');
            loadAccidents();
        } else {
            showNotification(data.message || '사고 삭제 중 오류가 발생했습니다.', 'danger');
        }
    })
    .catch(error => {
        console.error('사고 삭제 오류:', error);
        showNotification('사고 삭제 중 오류가 발생했습니다.', 'danger');
    });
}

// 인쇄 기능
function printAccident() {
    const content = document.getElementById('accidentDetails').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>사고 보고서 인쇄</title>
            <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
            <style>
                @media print {
                    .btn { display: none !important; }
                    body { background: white !important; color: black !important; }
                }
            </style>
        </head>
        <body>
            <div class="container mt-4">
                <h2>사고 보고서</h2>
                <hr>
                ${content}
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

// 필드 값 가져오기 헬퍼 함수
function getFieldValue(accident, field) {
    return accident[field] || '';
}

// HTML 이스케이프 함수
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
}

// 알림 표시 함수
function showNotification(message, type = 'info') {
    if (window.RDCenter && window.RDCenter.showNotification) {
        window.RDCenter.showNotification(message, type);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}