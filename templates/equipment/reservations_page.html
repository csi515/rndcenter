{% extends "base.html" %}

{% block title %}장비 예약{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-calendar-alt me-2"></i>장비 예약</h2>
                <button class="btn btn-primary" onclick="openReservationModal()">
                    <i class="fas fa-plus me-2"></i>예약 추가
                </button>
            </div>
            
            <!-- 캘린더 -->
            <div class="card">
                <div class="card-body">
                    <div id="reservationCalendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 예약 추가/수정 모달 -->
<div class="modal fade" id="reservationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reservationModalTitle">장비 예약</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reservationForm">
                    <input type="hidden" id="reservationId">
                    <div class="form-group mb-3">
                        <label class="form-label">예약자 이름 *</label>
                        <input type="text" class="form-control" id="reservationReserver" required>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">장비 선택 *</label>
                        <select class="form-control" id="reservationEquipment" required>
                            <option value="">장비를 선택하세요</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">예약 날짜 *</label>
                        <input type="date" class="form-control" id="reservationDate" required>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">시작 시간 *</label>
                        <select class="form-control" id="reservationStartTime" required>
                            {% for h in range(0,24) %}{% for m in (0,30) %}
                                <option value="{{'%02d:%02d' % (h, m)}}">{{'%02d:%02d' % (h, m)}}</option>
                            {% endfor %}{% endfor %}
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">종료 시간 *</label>
                        <select class="form-control" id="reservationEndTime" required>
                            {% for h in range(0,24) %}{% for m in (0,30) %}
                                <option value="{{'%02d:%02d' % (h, m)}}">{{'%02d:%02d' % (h, m)}}</option>
                            {% endfor %}{% endfor %}
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">사용 목적 *</label>
                        <textarea class="form-control" id="reservationPurpose" rows="3" required></textarea>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">비고</label>
                        <textarea class="form-control" id="reservationNotes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-danger" id="deleteReservationBtn" onclick="deleteReservationNew()" style="display: none;">삭제</button>
                <button type="button" class="btn btn-primary" onclick="saveReservationNew()">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<script>
let calendar;

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadReservationCalendar();
    loadEquipmentForReservation();
});

// 캘린더 초기화
function loadReservationCalendar() {
    const calendarEl = document.getElementById('reservationCalendar');
    if (!calendarEl) return;
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        height: 'auto',
        dayHeaderFormat: { weekday: 'short' },
        dayCellContent: function(arg) {
            return { html: arg.date.getDate() };
        },
        buttonText: {
            today: '오늘',
            month: '월',
            week: '주',
            day: '일'
        },
        titleFormat: { year: 'numeric', month: 'long' },
        events: async function(info, successCallback, failureCallback) {
            try {
                const response = await fetch('/equipment/api/reservations');
                const data = await response.json();
                
                if (data.success) {
                    const events = data.reservations.map(reservation => ({
                        id: reservation.id,
                        title: `${reservation.equipment_name} - ${reservation.reserver}`,
                        start: `${reservation.start_date}T${reservation.start_time}`,
                        end: `${reservation.end_date}T${reservation.end_time}`,
                        backgroundColor: getEquipmentColor(reservation.equipment_name),
                        borderColor: getEquipmentColor(reservation.equipment_name),
                        extendedProps: reservation
                    }));
                    successCallback(events);
                } else {
                    failureCallback();
                }
            } catch (error) {
                console.error('예약 데이터 로드 중 오류:', error);
                failureCallback();
            }
        },
        eventClick: function(info) {
            openEditReservationModal(info.event.extendedProps);
        },
        selectable: true,
        select: function(info) {
            openNewReservationModal(info.start, info.end);
        }
    });
    
    calendar.render();
}

function openNewReservationModal(start, end) {
    document.getElementById('reservationModalTitle').textContent = '장비 예약 추가';
    document.getElementById('reservationForm').reset();
    document.getElementById('reservationId').value = '';
    document.getElementById('deleteReservationBtn').style.display = 'none';

    const localDate = new Date(start.getTime() - (start.getTimezoneOffset() * 60000));
    document.getElementById('reservationDate').value = localDate.toISOString().split('T')[0];

    // 30분 단위로 반올림
    function roundTo30(date) {
      let h = date.getHours();
      let m = date.getMinutes();
      m = m < 30 ? 0 : 30;
      return ('0'+h).slice(-2) + ':' + ('0'+m).slice(-2);
    }
    document.getElementById('reservationStartTime').value = roundTo30(start);
    if (end) {
        document.getElementById('reservationEndTime').value = roundTo30(end);
    }
    new bootstrap.Modal(document.getElementById('reservationModal')).show();
}

function openEditReservationModal(reservation) {
    document.getElementById('reservationModalTitle').textContent = '장비 예약 수정';
    document.getElementById('reservationId').value = reservation.id;
    document.getElementById('reservationEquipment').value = reservation.equipment_id;
    document.getElementById('reservationReserver').value = reservation.reserver;
    document.getElementById('reservationDate').value = reservation.start_date;
    document.getElementById('reservationStartTime').value = reservation.start_time;
    document.getElementById('reservationEndTime').value = reservation.end_time;
    document.getElementById('reservationPurpose').value = reservation.purpose;
    document.getElementById('reservationNotes').value = reservation.notes || '';
    document.getElementById('deleteReservationBtn').style.display = 'inline-block';
    new bootstrap.Modal(document.getElementById('reservationModal')).show();
}

function openReservationModal() {
    document.getElementById('reservationModalTitle').textContent = '장비 예약 추가';
    document.getElementById('reservationForm').reset();
    document.getElementById('reservationId').value = '';
    document.getElementById('deleteReservationBtn').style.display = 'none';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('reservationDate').value = today;
    
    // 모달이 열릴 때마다 장비 목록을 새로 로드
    loadEquipmentForReservation();
    
    new bootstrap.Modal(document.getElementById('reservationModal')).show();
}

async function loadEquipmentForReservation() {
    try {
        const response = await fetch('/equipment/api/equipment');
        const data = await response.json();
            const select = document.getElementById('reservationEquipment');
        select.innerHTML = '<option value="">장비를 선택하세요</option>';
        if (data.success && Array.isArray(data.equipment)) {
            data.equipment.forEach(eq => {
                // 장비 상태가 '사용가능'인 것만 표시
                if (!eq.status || eq.status === '사용가능' || eq.status === '사용 가능') {
                    const option = document.createElement('option');
                    option.value = eq.id;
                    option.textContent = `${eq.name} (${eq.model || ''})`;
                    option.setAttribute('data-name', eq.name);
                    select.appendChild(option);
                }
            });
        }
    } catch (error) {
        console.error('장비 목록 로드 오류:', error);
    }
}

// 예약 저장
async function saveReservationNew() {
    const equipmentSelect = document.getElementById('reservationEquipment');
    const selectedOption = equipmentSelect.options[equipmentSelect.selectedIndex];
    
    const reservationData = {
        equipment_id: equipmentSelect.value,
        equipment_name: selectedOption ? selectedOption.getAttribute('data-name') : '',
        reserver: document.getElementById('reservationReserver').value,
        start_date: document.getElementById('reservationDate').value,
        end_date: document.getElementById('reservationDate').value,
        start_time: document.getElementById('reservationStartTime').value,
        end_time: document.getElementById('reservationEndTime').value,
        purpose: document.getElementById('reservationPurpose').value,
        notes: document.getElementById('reservationNotes').value
    };
    
    if (!reservationData.equipment_id || !reservationData.reserver || !reservationData.start_date || !reservationData.start_time || !reservationData.purpose) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }
    
    try {
        const id = document.getElementById('reservationId').value;
        let response;
        
        if (id) {
            response = await fetch(`/equipment/api/reservations/${id}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(reservationData)
            });
        } else {
            response = await fetch('/equipment/api/reservations/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(reservationData)
            });
        }
        
        const result = await response.json();
        if (result.success) {
            alert('예약이 저장되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('reservationModal')).hide();
            calendar.refetchEvents();
        } else {
            alert('오류: ' + (result.error || '저장에 실패했습니다.'));
        }
    } catch (error) {
        console.error('예약 저장 중 오류:', error);
        alert('저장 중 오류가 발생했습니다.');
    }
}

// 예약 삭제
async function deleteReservationNew() {
    const id = document.getElementById('reservationId').value;
    if (!id) return;
    
    if (confirm('이 예약을 삭제하시겠습니까?')) {
        try {
            const response = await fetch(`/equipment/api/reservations/${id}/delete`, {
                method: 'POST'
            });
            
            const result = await response.json();
            if (result.success) {
                alert('예약이 삭제되었습니다.');
                bootstrap.Modal.getInstance(document.getElementById('reservationModal')).hide();
                calendar.refetchEvents();
            } else {
                alert('오류: ' + (result.error || '삭제에 실패했습니다.'));
            }
        } catch (error) {
            console.error('예약 삭제 중 오류:', error);
            alert('삭제 중 오류가 발생했습니다.');
        }
    }
}

function getEquipmentColor(equipmentName) {
    const colors = [
        '#4F46E5', '#3B82F6', '#10B981', '#F59E0B', 
        '#EF4444', '#8B5CF6', '#06B6D4', '#84CC16'
    ];
    let hash = 0;
    for (let i = 0; i < equipmentName.length; i++) {
        const char = equipmentName.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return colors[Math.abs(hash) % colors.length];
}

// 페이지 로드시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadReservationCalendar();
    loadEquipmentForReservation(); // 장비 목록 미리 로드
});

// 페이지가 보여질 때마다 장비 목록 새로고침 (탭 전환 시)
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        loadEquipmentForReservation();
    }
});

// 포커스를 받을 때마다 장비 목록 새로고침
window.addEventListener('focus', function() {
    loadEquipmentForReservation();
});
</script>
{% endblock %}