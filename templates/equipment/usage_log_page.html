{% extends "base.html" %}

{% block title %}사용일지{% endblock %}

{% block extra_css %}
<style>
    /* 드롭다운 클릭 문제 해결을 위한 강력한 CSS */
    .form-select {
        position: relative !important;
        z-index: 1000 !important;
        pointer-events: auto !important;
        cursor: pointer !important;
        background-color: white !important;
        border: 1px solid #ced4da !important;
        border-radius: 0.375rem !important;
        padding: 0.375rem 2.25rem 0.375rem 0.75rem !important;
        appearance: menulist !important;
        -webkit-appearance: menulist !important;
        -moz-appearance: menulist !important;
    }
    
    .form-select:hover {
        border-color: #86b7fe !important;
        cursor: pointer !important;
    }
    
    .form-select:focus {
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        outline: 0 !important;
    }
    
    .form-select option {
        background-color: white !important;
        color: black !important;
        padding: 0.375rem 0.75rem !important;
    }
    
    /* 카드와 폼 요소들이 드롭다운을 방해하지 않도록 설정 */
    .card {
        z-index: 1 !important;
        position: relative !important;
    }
    
    .form-group {
        position: relative !important;
        z-index: 1 !important;
    }
    
    /* 테이블이 드롭다운을 방해하지 않도록 설정 */
    .table-responsive {
        z-index: 0 !important;
    }
    
    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-사용가능 {
        background-color: #d1edff;
        color: #0969da;
    }
    
    .status-이상있음 {
        background-color: #ffebe9;
        color: #cf222e;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-clipboard-list me-2"></i>사용일지</h2>
                <button class="btn btn-primary" id="openUsageLogModalBtn">
                    <i class="fas fa-plus"></i> 사용일지 작성
                </button>
            </div>
        </div>
    </div>

    <!-- 사용일지 작성 모달 -->
    <div class="modal fade" id="usageLogModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">사용일지 작성</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="usageLogForm">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">장비 선택 *</label>
                  <select class="form-select" id="usageEquipment" required>
                    <option value="">장비를 선택하세요</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">사용자 *</label>
                  <input type="text" class="form-control" id="usageUser" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">사용일 *</label>
                  <input type="date" class="form-control" id="usageDate" required>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">시작 시간 *</label>
                  <input type="time" class="form-control" id="usageStartTime" required step="1800">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">종료 시간</label>
                  <input type="time" class="form-control" id="usageEndTime" step="1800">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">사용 목적 *</label>
                  <textarea class="form-control" id="usagePurpose" rows="2" required></textarea>
                </div>
              </div>
              <div class="form-group mb-3">
                <label class="form-label">사용 후 상태</label>
                <select class="form-select" id="usageCondition">
                  <option value="정상">정상</option>
                  <option value="주의">주의</option>
                  <option value="이상있음">이상있음</option>
                </select>
              </div>
              <div class="form-group mb-3">
                <label class="form-label">사용 중 특이사항</label>
                <textarea class="form-control" id="usageIssues" rows="3" placeholder="사용 중 발생한 문제나 특이사항을 기록하세요"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button type="button" class="btn btn-primary" onclick="saveNewUsageLog()">
              <i class="fas fa-save me-2"></i>사용일지 저장
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 사용일지 목록 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>사용일지 목록</h5>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="filterEquipment" onchange="filterUsageLogs()" style="width: 200px;">
                                <option value="">전체 장비</option>
                            </select>
                            <input type="month" class="form-control form-control-sm" id="filterMonth" onchange="filterUsageLogs()" style="width: 150px;">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>날짜</th>
                                    <th>장비명</th>
                                    <th>사용자</th>
                                    <th>시작시간</th>
                                    <th>종료시간</th>
                                    <th>목적</th>
                                    <th>상태</th>
                                    <th>특이사항</th>
                                    <th>액션</th>
                                </tr>
                            </thead>
                            <tbody id="usageLogTableBody">
                                <!-- 사용일지 목록이 여기에 동적으로 로드됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadNewUsageLogs();
    loadEquipmentForUsage(); // 장비 목록 미리 로드
    
    // 드롭다운 클릭 문제 해결을 위한 강제 이벤트 핸들러
    setTimeout(() => {
        const usageEquipmentSelect = document.getElementById('usageEquipment');
        const filterEquipmentSelect = document.getElementById('filterEquipment');
        const usageConditionSelect = document.getElementById('usageCondition');
        
        // 클릭 이벤트 강제 바인딩
        [usageEquipmentSelect, filterEquipmentSelect, usageConditionSelect].forEach(select => {
            if (select) {
                // 기본 클릭 이벤트 보장
                select.addEventListener('click', function(e) {
                    console.log('드롭다운 클릭됨:', this.id);
                    e.stopPropagation();
                    this.focus();
                    // 브라우저 기본 드롭다운 동작 강제 실행
                    if (this.size === 1) {
                        this.size = Math.min(this.options.length, 10);
                        setTimeout(() => {
                            this.size = 1;
                        }, 100);
                    }
                });
                
                // 마우스오버 시 커서 포인터 확실히 설정
                select.addEventListener('mouseenter', function() {
                    this.style.cursor = 'pointer';
                });
                
                // 포커스 이벤트
                select.addEventListener('focus', function() {
                    console.log('드롭다운 포커스됨:', this.id);
                });
                
                // 터치 이벤트 (모바일 대응)
                select.addEventListener('touchstart', function(e) {
                    console.log('드롭다운 터치됨:', this.id);
                    this.focus();
                });
            }
        });
    }, 1000);

    const usageLogBtn = document.getElementById('openUsageLogModalBtn');
    if (usageLogBtn) {
        usageLogBtn.onclick = function() {
            // 폼 초기화
            document.getElementById('usageLogForm').reset();
            setCurrentDateTime();
            // 저장 버튼을 신규 작성 모드로 복구
            const saveBtn = document.querySelector('#usageLogModal .btn-primary');
            saveBtn.onclick = saveNewUsageLog;
            // 모달 열기
            const modal = new bootstrap.Modal(document.getElementById('usageLogModal'));
            modal.show();
        };
    }
});

// 새로운 사용일지 함수들
function loadNewUsageLogs() {
    loadUsageLogsData();
    loadEquipmentForUsage();
    setCurrentDateTime();
}

async function loadUsageLogsData() {
    try {
        const response = await fetch('/equipment/api/usage-logs');
        const data = await response.json();
        
        if (data.success) {
            renderNewUsageLogTable(data.logs);
        }
    } catch (error) {
        console.error('사용일지 로드 중 오류:', error);
    }
}

async function loadEquipmentForUsage() {
    try {
        const response = await fetch('/equipment/api/equipment');
        const data = await response.json();
        const select = document.getElementById('usageEquipment');
        const filterSelect = document.getElementById('filterEquipment');
        select.disabled = false; // 항상 활성화
        let html = '<option value="">장비를 선택하세요</option>';
        let filterHtml = '<option value="">전체 장비</option>';
        if (data.success && data.equipment && data.equipment.length > 0) {
            data.equipment.forEach(equipment => {
                // 상태가 '사용가능'인 장비만 선택 가능하게
                const isUsable = equipment.status === '사용가능' || equipment.status === '사용 가능';
                html += `<option value="${equipment.name}"${isUsable ? '' : ' disabled'}>${equipment.name} (${equipment.asset_number || '-'})</option>`;
                filterHtml += `<option value="${equipment.name}">${equipment.name} (${equipment.asset_number || '-'})</option>`;
            });
        } else {
            html += '<option value="" disabled>등록된 장비 없음</option>';
            filterHtml += '<option value="" disabled>등록된 장비 없음</option>';
        }
        select.innerHTML = html;
        filterSelect.innerHTML = filterHtml;
    } catch (error) {
        const select = document.getElementById('usageEquipment');
        const filterSelect = document.getElementById('filterEquipment');
        select.innerHTML = '<option value="" disabled>장비 목록 로드 오류</option>';
        filterSelect.innerHTML = '<option value="" disabled>장비 목록 로드 오류</option>';
        select.disabled = true;
    }
}

function setCurrentDateTime() {
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const currentTime = now.toTimeString().slice(0, 5);
    
    document.getElementById('usageDate').value = today;
    document.getElementById('usageStartTime').value = currentTime;
}

async function saveNewUsageLog() {
    const usageData = {
        equipment_name: document.getElementById('usageEquipment').value,
        user: document.getElementById('usageUser').value,
        usage_date: document.getElementById('usageDate').value,
        start_time: document.getElementById('usageStartTime').value,
        end_time: document.getElementById('usageEndTime').value,
        purpose: document.getElementById('usagePurpose').value,
        condition_after: document.getElementById('usageCondition').value,
        issues: document.getElementById('usageIssues').value
    };
    
    if (!usageData.equipment_name || !usageData.user || !usageData.usage_date || !usageData.start_time || !usageData.purpose) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }
    
    try {
        const response = await fetch('/equipment/api/usage-logs/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(usageData)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('사용일지가 저장되었습니다.');
            document.getElementById('usageLogForm').reset();
            setCurrentDateTime();
            loadUsageLogsData();
        } else {
            alert('오류: ' + (result.error || '저장에 실패했습니다.'));
        }
    } catch (error) {
        console.error('사용일지 저장 중 오류:', error);
        alert('저장 중 오류가 발생했습니다.');
    }
}

function filterUsageLogs() {
    const equipment = document.getElementById('filterEquipment').value;
    const month = document.getElementById('filterMonth').value; // yyyy-MM
    loadUsageLogsDataFiltered(equipment, month);
}

async function loadUsageLogsDataFiltered(equipment, month) {
    try {
        const response = await fetch('/equipment/api/usage-logs');
        const data = await response.json();
        if (data.success) {
            let logs = data.logs;
            if (equipment) {
                logs = logs.filter(log => log.equipment_name === equipment);
            }
            if (month) {
                logs = logs.filter(log => log.usage_date && log.usage_date.startsWith(month));
            }
            renderNewUsageLogTable(logs);
        }
    } catch (error) {
        console.error('사용일지 로드 중 오류:', error);
    }
}

function renderNewUsageLogTable(logs) {
    const tbody = document.getElementById('usageLogTableBody');
    let html = '';
    
    logs.forEach(log => {
        html += `
        <tr>
            <td>${log.usage_date}</td>
            <td>${log.equipment_name}</td>
            <td>${log.user}</td>
            <td>${log.start_time}</td>
            <td>${log.end_time || '-'}</td>
            <td>${log.purpose}</td>
            <td>
                <span class="status-badge ${log.condition_after === '정상' ? 'status-사용가능' : 'status-이상있음'}">
                    ${log.condition_after}
                </span>
            </td>
            <td>${log.issues || '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editUsageLog('${log.id}')">수정</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteUsageLog('${log.id}')">삭제</button>
            </td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
}

function deleteUsageLog(logId) {
    if (!confirm('정말로 이 사용일지를 삭제하시겠습니까?')) return;
    fetch(`/equipment/api/usage-logs/${logId}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            alert('삭제되었습니다.');
            loadUsageLogsData();
        } else {
            alert('삭제 실패: ' + (result.error || '오류'));
        }
    })
    .catch(() => alert('삭제 중 오류가 발생했습니다.'));
}

function editUsageLog(logId) {
    // 해당 로그 데이터 찾기 (이미 테이블에 있으므로 logs 배열에서 찾거나, API 재호출)
    fetch('/equipment/api/usage-logs')
    .then(res => res.json())
    .then(data => {
        if (!data.success) throw new Error('데이터 로드 실패');
        const log = data.logs.find(l => l.id == logId);
        if (!log) throw new Error('사용일지 없음');
        // 모달 열고 값 채우기
        document.getElementById('usageEquipment').value = log.equipment_name;
        document.getElementById('usageUser').value = log.user;
        document.getElementById('usageDate').value = log.usage_date;
        document.getElementById('usageStartTime').value = log.start_time;
        document.getElementById('usageEndTime').value = log.end_time;
        document.getElementById('usagePurpose').value = log.purpose;
        document.getElementById('usageCondition').value = log.condition_after;
        document.getElementById('usageIssues').value = log.issues;
        // 저장 버튼에 수정용 핸들러 임시 부착
        const saveBtn = document.querySelector('#usageLogModal .btn-primary');
        saveBtn.onclick = function() {
            const usageData = {
                equipment_name: document.getElementById('usageEquipment').value,
                user: document.getElementById('usageUser').value,
                usage_date: document.getElementById('usageDate').value,
                start_time: document.getElementById('usageStartTime').value,
                end_time: document.getElementById('usageEndTime').value,
                purpose: document.getElementById('usagePurpose').value,
                condition_after: document.getElementById('usageCondition').value,
                issues: document.getElementById('usageIssues').value
            };
            fetch(`/equipment/api/usage-logs/${logId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(usageData)
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    alert('수정되었습니다.');
                    document.getElementById('usageLogForm').reset();
                    loadUsageLogsData();
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('usageLogModal')).hide();
                } else {
                    alert('수정 실패: ' + (result.error || '오류'));
                }
            })
            .catch(() => alert('수정 중 오류가 발생했습니다.'));
        };
        // 모달 열기
        bootstrap.Modal.getOrCreateInstance(document.getElementById('usageLogModal')).show();
    })
    .catch(e => alert('수정 데이터 로드 오류: ' + e.message));
}
</script>
{% endblock %}