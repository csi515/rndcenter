{% extends 'base.html' %}
{% block title %}콜타르피치 휘발물 사용일지{% endblock %}
{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">콜타르피치 휘발물 사용일지</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLogModal">일지 추가</button>
  </div>
  <form class="row g-2 mb-3" method="get">
    <div class="col-auto">
      <input type="text" class="form-control" name="search" placeholder="사용자/내용 검색" value="{{ request.args.get('search', '') }}">
    </div>
    <div class="col-auto">
      <input type="date" class="form-control" name="date_from" value="{{ request.args.get('date_from', '') }}">
    </div>
    <div class="col-auto">
      <input type="date" class="form-control" name="date_to" value="{{ request.args.get('date_to', '') }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-secondary" type="submit">검색</button>
    </div>
  </form>
  <div class="table-responsive" style="max-height:600px;overflow:auto;">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>사용자</th>
          <th>사용 물질</th>
          <th>사용 일시</th>
          <th>작업 장소</th>
          <th>작업 내용</th>
          <th>사용량</th>
          <th>보호구 착용</th>
          <th>공정 조건</th>
          <th>유해 노출 반응</th>
          <th>조치 및 비고</th>
          <th>작성자</th>
          <th>관리자 서명</th>
          <th>액션</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td>{{ log.user }}</td>
          <td>{{ log.material }}</td>
          <td>{{ log.used_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ log.location }}</td>
          <td>{{ log.work_content }}</td>
          <td>{{ log.amount }}</td>
          <td><input type="checkbox" {% if log.ppe %}checked{% endif %} disabled></td>
          <td>{{ log.process_condition }}</td>
          <td>{{ log.exposure_reaction }}</td>
          <td>{{ log.action_note }}</td>
          <td>{{ log.writer }}</td>
          <td>{{ log.manager_sign }}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary" onclick="editLog({{ log.id }})">수정</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteLog({{ log.id }})">삭제</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- 일지 추가/수정 모달 -->
<div class="modal fade" id="addLogModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="logForm">
        <div class="modal-header">
          <h5 class="modal-title">일지 작성</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-6">
            <label class="form-label">사용자</label>
            <input type="text" class="form-control" name="user" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">사용 물질</label>
            <input type="text" class="form-control" name="material" value="콜타르피치 휘발물" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">사용 일시</label>
            <input type="datetime-local" class="form-control" name="used_at" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">작업 장소</label>
            <input type="text" class="form-control" name="location">
          </div>
          <div class="col-md-6">
            <label class="form-label">작업 내용</label>
            <input type="text" class="form-control" name="work_content">
          </div>
          <div class="col-md-6">
            <label class="form-label">사용량 (단위 포함)</label>
            <input type="text" class="form-control" name="amount">
          </div>
          <div class="col-md-6">
            <label class="form-label">보호구 착용 여부</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="ppe" id="ppeCheck">
              <label class="form-check-label" for="ppeCheck">착용</label>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">공정 조건</label>
            <input type="text" class="form-control" name="process_condition">
          </div>
          <div class="col-md-6">
            <label class="form-label">유해 노출 반응</label>
            <input type="text" class="form-control" name="exposure_reaction">
          </div>
          <div class="col-md-6">
            <label class="form-label">조치 및 비고</label>
            <input type="text" class="form-control" name="action_note">
          </div>
          <div class="col-md-6">
            <label class="form-label">작성자</label>
            <input type="text" class="form-control" name="writer">
          </div>
          <div class="col-md-6">
            <label class="form-label">관리자 서명</label>
            <input type="text" class="form-control" name="manager_sign">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// 일지 추가/수정/삭제 JS (AJAX)
function editLog(id) {
  // TODO: 수정 모달 띄우기 (기본값 채우기)
}
function deleteLog(id) {
  if(confirm('정말 삭제하시겠습니까?')) {
    fetch(`/coal-tar-pitch-log/delete/${id}`, {method:'POST'})
      .then(r=>r.json()).then(res=>{ if(res.success) location.reload(); });
  }
}
document.getElementById('logForm').onsubmit = function(e) {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);
  fetch('/coal-tar-pitch-log/add', {method:'POST', body:data})
    .then(r=>r.json()).then(res=>{ if(res.success) location.reload(); });
}
</script>
{% endblock %} 