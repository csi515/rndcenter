{% extends "base.html" %}

{% block title %}안전 교육자료 - R&D 센터 관리시스템{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="fas fa-book"></i> 안전 교육자료</h2>
    </div>
</div>

<!-- 교육자료 추가 폼 -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-plus"></i> 새 교육자료 추가</h5>
    </div>
    <div class="card-body">
        <form id="addMaterialForm">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="title" class="form-label">제목 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="mb-3">
                        <label for="content" class="form-label">내용 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="content" name="content" rows="2" required></textarea>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="link" class="form-label">링크</label>
                        <input type="url" class="form-control" id="link" name="link" placeholder="https://...">
                    </div>
                </div>
            </div>
            <div class="text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> 등록
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 교육자료 목록 테이블 -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-list"></i> 교육자료 목록</h5>
        <div>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadMaterials()">
                <i class="fas fa-sync-alt"></i> 새로고침
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle" id="materialsTable">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 25%;">제목</th>
                        <th style="width: 45%;">내용</th>
                        <th style="width: 20%;">링크</th>
                        <th style="width: 10%;">작업</th>
                    </tr>
                </thead>
                <tbody id="materialsTableBody">
                    <!-- 데이터가 여기에 동적으로 로드됩니다 -->
                </tbody>
            </table>
        </div>
        
        <!-- 빈 상태 메시지 -->
        <div id="emptyMessage" class="text-center py-5 d-none">
            <i class="fas fa-book fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">등록된 교육자료가 없습니다</h5>
            <p class="text-muted">상단 폼을 통해 새로운 교육자료를 추가해보세요.</p>
        </div>
    </div>
</div>

<!-- 수정 모달 -->
<div class="modal fade" id="editMaterialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> 교육자료 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMaterialForm">
                    <input type="hidden" id="editMaterialId">
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">제목 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editContent" class="form-label">내용 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editContent" name="content" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editLink" class="form-label">링크</label>
                        <input type="url" class="form-control" id="editLink" name="link" placeholder="https://...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveMaterialEdit()">
                    <i class="fas fa-save"></i> 저장
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 응급연락처 패널 -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-phone"></i> 응급연락처</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <i class="fas fa-fire-extinguisher fa-2x text-danger mb-2"></i>
                    <h6>소방서</h6>
                    <strong>119</strong>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <i class="fas fa-ambulance fa-2x text-success mb-2"></i>
                    <h6>응급실</h6>
                    <strong>119</strong>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <i class="fas fa-shield-alt fa-2x text-primary mb-2"></i>
                    <h6>안전관리자</h6>
                    <strong>내선 1234</strong>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <i class="fas fa-tools fa-2x text-warning mb-2"></i>
                    <h6>시설관리</h6>
                    <strong>내선 5678</strong>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 페이지 로드 시 교육자료 목록 불러오기
document.addEventListener('DOMContentLoaded', function() {
    loadMaterials();
    
    // 폼 제출 이벤트 리스너
    document.getElementById('addMaterialForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addMaterial();
    });
});

// 교육자료 목록 로드
function loadMaterials() {
    console.log('교육자료 목록 로드 시작');
    
    fetch('/safety/api/materials')
        .then(response => response.json())
        .then(data => {
            console.log('교육자료 API 응답:', data);
            
            if (data.success) {
                renderMaterialsTable(data.materials);
            } else {
                console.error('교육자료 로드 실패:', data.message);
                showNotification(data.message || '교육자료 목록을 불러오는 중 오류가 발생했습니다.', 'danger');
            }
        })
        .catch(error => {
            console.error('교육자료 로드 오류:', error);
            showNotification('교육자료 목록을 불러오는 중 오류가 발생했습니다.', 'danger');
        });
}

// 테이블 렌더링
function renderMaterialsTable(materials) {
    const tbody = document.getElementById('materialsTableBody');
    const emptyMessage = document.getElementById('emptyMessage');
    
    if (!materials || materials.length === 0) {
        tbody.innerHTML = '';
        emptyMessage.classList.remove('d-none');
        return;
    }
    
    emptyMessage.classList.add('d-none');
    
    tbody.innerHTML = materials.map(material => `
        <tr>
            <td>
                <strong>${escapeHtml(material.title)}</strong>
            </td>
            <td>
                <div style="max-width: 400px; word-wrap: break-word;">
                    ${escapeHtml(material.content)}
                </div>
            </td>
            <td>
                ${material.link ? 
                    `<a href="${escapeHtml(material.link)}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i> 열기
                    </a>` : 
                    '<span class="text-muted">링크 없음</span>'
                }
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary" onclick="editMaterial(${material.id})" title="수정">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteMaterial(${material.id})" title="삭제">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// 교육자료 추가
function addMaterial() {
    const form = document.getElementById('addMaterialForm');
    const formData = new FormData(form);
    
    console.log('교육자료 추가 요청');
    
    fetch('/safety/api/materials/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('교육자료 추가 응답:', data);
        
        if (data.success) {
            showNotification(data.message || '교육자료가 성공적으로 추가되었습니다.', 'success');
            form.reset();
            loadMaterials();
        } else {
            showNotification(data.message || '교육자료 추가 중 오류가 발생했습니다.', 'danger');
        }
    })
    .catch(error => {
        console.error('교육자료 추가 오류:', error);
        showNotification('교육자료 추가 중 오류가 발생했습니다.', 'danger');
    });
}

// 교육자료 수정 모달 열기
function editMaterial(materialId) {
    console.log('교육자료 수정 모달 열기:', materialId);
    
    // 테이블에서 해당 교육자료 데이터 찾기
    fetch('/safety/api/materials')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const material = data.materials.find(m => m.id === materialId);
                if (material) {
                    document.getElementById('editMaterialId').value = material.id;
                    document.getElementById('editTitle').value = material.title;
                    document.getElementById('editContent').value = material.content;
                    document.getElementById('editLink').value = material.link || '';
                    
                    new bootstrap.Modal(document.getElementById('editMaterialModal')).show();
                }
            }
        })
        .catch(error => {
            console.error('교육자료 정보 로드 오류:', error);
            showNotification('교육자료 정보를 불러오는 중 오류가 발생했습니다.', 'danger');
        });
}

// 교육자료 수정 저장
function saveMaterialEdit() {
    const materialId = document.getElementById('editMaterialId').value;
    const form = document.getElementById('editMaterialForm');
    const formData = new FormData(form);
    
    console.log('교육자료 수정 저장:', materialId);
    
    fetch(`/safety/api/materials/${materialId}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('교육자료 수정 응답:', data);
        
        if (data.success) {
            showNotification(data.message || '교육자료가 성공적으로 수정되었습니다.', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editMaterialModal')).hide();
            loadMaterials();
        } else {
            showNotification(data.message || '교육자료 수정 중 오류가 발생했습니다.', 'danger');
        }
    })
    .catch(error => {
        console.error('교육자료 수정 오류:', error);
        showNotification('교육자료 수정 중 오류가 발생했습니다.', 'danger');
    });
}

// 교육자료 삭제
function deleteMaterial(materialId) {
    if (!confirm('이 교육자료를 삭제하시겠습니까?')) {
        return;
    }
    
    console.log('교육자료 삭제:', materialId);
    
    fetch(`/safety/api/materials/${materialId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        console.log('교육자료 삭제 응답:', data);
        
        if (data.success) {
            showNotification(data.message || '교육자료가 성공적으로 삭제되었습니다.', 'success');
            loadMaterials();
        } else {
            showNotification(data.message || '교육자료 삭제 중 오류가 발생했습니다.', 'danger');
        }
    })
    .catch(error => {
        console.error('교육자료 삭제 오류:', error);
        showNotification('교육자료 삭제 중 오류가 발생했습니다.', 'danger');
    });
}

// HTML 이스케이프 함수
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// 알림 표시 함수
function showNotification(message, type = 'info') {
    if (window.RDCenter && window.RDCenter.showNotification) {
        window.RDCenter.showNotification(message, type);
    } else {
        // Fallback for simple alert
        alert(message);
    }
}
</script>
{% endblock %}