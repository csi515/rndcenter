{% extends "base.html" %}

{% block title %}프로젝트 일정 관리{% endblock %}

{% block extra_head %}
<style>
.schedule-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.filter-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-radius: 12px;
    color: white;
}

.calendar-nav {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.btn-nav {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn-nav:hover {
    background: rgba(255,255,255,0.3);
    color: white;
}

/* 3개월 가로 레이아웃 */
.three-month-container {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 1rem;
}

.month-section {
    min-width: 400px;
    flex: 1;
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
}

.month-header {
    background: #007bff;
    color: white;
    text-align: center;
    padding: 1rem;
    font-weight: 600;
    font-size: 1.1rem;
}

.month-header.prev-month {
    background: #6c757d;
}

.month-header.next-month {
    background: #6c757d;
}

.week-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    border-bottom: 1px solid #dee2e6;
}

.week-header {
    background: #495057;
    color: white;
    text-align: center;
    padding: 0.5rem 0.25rem;
    font-size: 0.8rem;
    font-weight: 600;
    border-right: 1px solid #6c757d;
}

.week-header:last-child {
    border-right: none;
}

/* 계획 그룹화 */
.plan-groups {
    max-height: 500px;
    overflow-y: auto;
}

.plan-group {
    border-bottom: 1px solid #dee2e6;
}

.plan-group:last-child {
    border-bottom: none;
}

.plan-header {
    background: #e9ecef;
    padding: 0.75rem 1rem;
    font-weight: 600;
    color: #495057;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.2s;
}

.plan-header:hover {
    background: #dee2e6;
}

.plan-header .toggle-arrow {
    transition: transform 0.2s;
}

.plan-header.collapsed .toggle-arrow {
    transform: rotate(-90deg);
}

.plan-content {
    display: none;
}

.plan-content.show {
    display: block;
}

/* 텍스트 그룹화로 공간 절약 */
.grouped-schedules {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
}

.week-cell {
    border-right: 1px solid #dee2e6;
    border-bottom: 1px solid #dee2e6;
    min-height: 80px;
    position: relative;
    background: white;
}

.week-cell:last-child {
    border-right: none;
}

.week-cell:hover {
    background: #f8f9fa;
}

/* 그룹화된 일정 아이템 */
.schedule-group {
    padding: 0.4rem;
    margin: 0.2rem;
    border-radius: 4px;
    font-size: 0.75rem;
    position: relative;
}

.schedule-group.common-text {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
}

.schedule-group.unique-text {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    color: white;
}

.schedule-group.multi-project {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    color: #212529;
}

.group-header {
    font-weight: 600;
    margin-bottom: 0.2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.group-count {
    background: rgba(255,255,255,0.3);
    border-radius: 10px;
    padding: 0.1rem 0.4rem;
    font-size: 0.65rem;
}

.group-items {
    font-size: 0.7rem;
    line-height: 1.2;
}

.group-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.1rem;
    padding: 0.1rem 0;
}

.item-title {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: 0.3rem;
}

.item-researcher {
    font-size: 0.6rem;
    opacity: 0.8;
}

/* 빈 셀 추가 버튼 */
.add-schedule-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #007bff;
    border: none;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
    cursor: pointer;
    font-size: 0.7rem;
}

.week-cell:hover .add-schedule-btn {
    opacity: 1;
}

/* 아코디언 상세 정보 */
.schedule-details {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0 0 4px 4px;
    padding: 0.5rem;
    font-size: 0.7rem;
    color: #495057;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: none;
    max-width: 250px;
}

.schedule-details.show {
    display: block;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.3rem;
    font-size: 0.65rem;
}

.detail-label {
    font-weight: 600;
    color: #6c757d;
}

/* 반응형 */
@media (max-width: 1200px) {
    .three-month-container {
        flex-direction: column;
    }
    
    .month-section {
        min-width: auto;
    }
    
    .week-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .grouped-schedules {
        grid-template-columns: repeat(4, 1fr);
    }
}

@media (max-width: 768px) {
    .week-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .grouped-schedules {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .week-cell {
        min-height: 60px;
    }
}

/* 드래그 앤 드롭 */
.schedule-group.dragging {
    opacity: 0.5;
    transform: scale(0.95);
}

.week-cell.drag-over {
    background: #c3e6cb !important;
    border: 2px dashed #28a745;
}

/* 계획 추가 버튼 */
.add-plan-section {
    background: #f8f9fa;
    border: 2px dashed #007bff;
    color: #007bff;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.add-plan-section:hover {
    background: #e3f2fd;
    border-color: #0056b3;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-calendar-alt me-2 text-primary"></i>프로젝트 일정 관리
                </h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" onclick="addNewPlan()">
                        <i class="fas fa-plus me-1"></i>계획 추가
                    </button>
                    <button class="btn btn-outline-primary" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-1"></i>엑셀 내보내기
                    </button>
                </div>
            </div>

            <!-- 필터 섹션 -->
            <div class="filter-section">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">프로젝트 필터</label>
                        <select class="form-select" id="projectFilter" onchange="filterSchedules()">
                            <option value="">모든 프로젝트</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">연구원 필터</label>
                        <select class="form-select" id="researcherFilter" onchange="filterSchedules()">
                            <option value="">모든 연구원</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">일정 검색</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="일정 제목 검색..." onkeyup="filterSchedules()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-outline-secondary d-block w-100" onclick="resetFilters()">
                            <i class="fas fa-undo me-1"></i>초기화
                        </button>
                    </div>
                </div>
            </div>

            <!-- 캘린더 컨테이너 -->
            <div class="schedule-container">
                <div class="calendar-header">
                    <h4 class="mb-0" id="calendarTitle">프로젝트 일정 캘린더</h4>
                    <div class="calendar-nav">
                        <button class="btn-nav" onclick="goToPreviousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="btn-nav" onclick="goToToday()">오늘</button>
                        <button class="btn-nav" onclick="goToNextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 계획 추가 섹션 -->
                <div class="add-plan-section" onclick="addNewPlan()">
                    <i class="fas fa-plus me-2"></i>새 계획 추가하기
                </div>

                <!-- 3개월 가로 레이아웃 -->
                <div class="three-month-container" id="threeMonthContainer">
                    <!-- JavaScript로 동적 생성 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 계획 추가/수정 모달 -->
<div class="modal fade" id="planModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="planModalTitle">계획 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <input type="hidden" id="planId">
                    <div class="mb-3">
                        <label class="form-label">계획명</label>
                        <input type="text" class="form-control" id="planName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">프로젝트 연결 (선택)</label>
                        <select class="form-select" id="planProjectId">
                            <option value="">독립 계획</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-danger" id="deletePlanBtn" onclick="deletePlan()" style="display: none;">삭제</button>
                <button type="button" class="btn btn-primary" onclick="savePlan()">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- 일정 추가/수정 모달 -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleModalTitle">일정 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <input type="hidden" id="scheduleId">
                    <input type="hidden" id="schedulePlanId">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">일정 제목</label>
                            <input type="text" class="form-control" id="modalTitle" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">시작 주차</label>
                            <input type="number" class="form-control" id="modalStartWeek" min="1" max="5" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">종료 주차</label>
                            <input type="number" class="form-control" id="modalEndWeek" min="1" max="5" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">월</label>
                            <input type="number" class="form-control" id="modalStartMonth" min="1" max="12" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">연도</label>
                            <input type="number" class="form-control" id="modalStartYear" value="2025" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">담당자</label>
                            <input type="text" class="form-control" id="modalResearchers" placeholder="담당 연구원 이름">
                        </div>
                        <div class="col-12">
                            <label class="form-label">메모</label>
                            <textarea class="form-control" id="modalMemo" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-danger" id="deleteScheduleBtn" onclick="deleteSchedule()" style="display: none;">삭제</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">저장</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentMonth = new Date().getMonth() + 1;
let currentYear = new Date().getFullYear();
let schedules = [];
let projects = [];
let researchers = [];
let plans = [];

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadProjects();
    loadResearchers();
    loadSchedules();
});

// 프로젝트 목록 로드
function loadProjects() {
    fetch('/research/projects/api')
        .then(response => response.json())
        .then(data => {
            projects = data;
            updateProjectFilters();
        })
        .catch(error => {
            console.error('프로젝트 로드 오류:', error);
            projects = [];
            updateProjectFilters();
        });
}

// 연구원 목록 로드
function loadResearchers() {
    fetch('/research/researchers/api')
        .then(response => response.json())
        .then(data => {
            researchers = data;
            updateResearcherFilters();
        })
        .catch(error => {
            console.error('연구원 로드 오류:', error);
            researchers = [];
            updateResearcherFilters();
        });
}

// 일정 목록 로드
function loadSchedules() {
    fetch('/research/schedule/projects/api')
        .then(response => response.json())
        .then(data => {
            schedules = data || [];
            generatePlansFromSchedules();
            generateThreeMonthView();
        })
        .catch(error => {
            console.error('일정 로드 오류:', error);
            schedules = [];
            generatePlansFromSchedules();
            generateThreeMonthView();
        });
}

// 스케줄에서 계획 생성
function generatePlansFromSchedules() {
    const planMap = new Map();
    
    schedules.forEach(schedule => {
        const project = projects.find(p => p.project_id === schedule.project_id);
        const planKey = schedule.project_id || 'independent';
        const planName = project ? project.name : '독립 일정';
        
        if (!planMap.has(planKey)) {
            planMap.set(planKey, {
                id: planKey,
                name: planName,
                project_id: schedule.project_id,
                schedules: []
            });
        }
        
        planMap.get(planKey).schedules.push(schedule);
    });
    
    plans = Array.from(planMap.values());
    
    // 기본 계획이 없으면 추가
    if (plans.length === 0) {
        plans.push({
            id: 'default',
            name: '기본 계획',
            project_id: null,
            schedules: []
        });
    }
}

// 프로젝트 필터 업데이트
function updateProjectFilters() {
    const projectFilter = document.getElementById('projectFilter');
    const planProjectId = document.getElementById('planProjectId');
    
    projectFilter.innerHTML = '<option value="">모든 프로젝트</option>';
    planProjectId.innerHTML = '<option value="">독립 계획</option>';
    
    projects.forEach(project => {
        projectFilter.innerHTML += `<option value="${project.project_id}">${project.name}</option>`;
        planProjectId.innerHTML += `<option value="${project.project_id}">${project.name}</option>`;
    });
}

// 연구원 필터 업데이트
function updateResearcherFilters() {
    const researcherFilter = document.getElementById('researcherFilter');
    researcherFilter.innerHTML = '<option value="">모든 연구원</option>';
    
    researchers.forEach(researcher => {
        researcherFilter.innerHTML += `<option value="${researcher.employee_id}">${researcher.name}</option>`;
    });
}

// 3개월 가로 뷰 생성
function generateThreeMonthView() {
    const container = document.getElementById('threeMonthContainer');
    const months = [currentMonth - 1, currentMonth, currentMonth + 1];
    const currentDate = new Date();
    
    let html = '';
    
    months.forEach((monthOffset, monthIndex) => {
        const adjustedMonth = monthOffset <= 0 ? 12 + monthOffset : monthOffset > 12 ? monthOffset - 12 : monthOffset;
        const adjustedYear = monthOffset <= 0 ? currentYear - 1 : monthOffset > 12 ? currentYear + 1 : currentYear;
        const monthName = adjustedMonth + '월 ' + adjustedYear;
        const weeksInMonth = getWeeksInMonth(adjustedYear, adjustedMonth);
        
        let monthClass = 'month-header';
        if (monthIndex === 0) monthClass += ' prev-month';
        else if (monthIndex === 2) monthClass += ' next-month';
        
        html += `
        <div class="month-section">
            <div class="${monthClass}">${monthName}</div>
            <div class="week-grid">`;
        
        // 주차 헤더
        for (let week = 1; week <= weeksInMonth; week++) {
            html += `<div class="week-header">${week}주</div>`;
        }
        
        html += `</div>
            <div class="plan-groups">`;
        
        // 계획별 그룹 생성
        plans.forEach(plan => {
            html += generatePlanGroup(plan, adjustedMonth, adjustedYear, weeksInMonth);
        });
        
        html += `</div>
        </div>`;
    });
    
    container.innerHTML = html;
    
    // 아코디언 이벤트 추가
    initializeAccordions();
    // 드래그 앤 드롭 초기화
    initializeDragAndDrop();
}

// 계획 그룹 생성
function generatePlanGroup(plan, month, year, weeksInMonth) {
    const planSchedules = plan.schedules.filter(s => 
        s.start_month === month && s.start_year === year
    );
    
    let html = `
    <div class="plan-group">
        <div class="plan-header" onclick="togglePlanGroup(this)">
            <span>${plan.name}</span>
            <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
        </div>
        <div class="plan-content show">
            <div class="grouped-schedules">`;
    
    // 주차별 셀 생성
    for (let week = 1; week <= weeksInMonth; week++) {
        const weekSchedules = planSchedules.filter(s => 
            week >= s.start_week && week <= s.end_week
        );
        
        html += `<div class="week-cell" data-month="${month}" data-week="${week}" data-year="${year}" data-plan="${plan.id}">`;
        
        if (weekSchedules.length > 0) {
            html += generateGroupedSchedules(weekSchedules);
        } else {
            html += `<div class="add-schedule-btn" onclick="openScheduleModal(${month}, ${week}, ${year}, '${plan.id}')">
                <i class="fas fa-plus"></i>
            </div>`;
        }
        
        html += `</div>`;
    }
    
    html += `</div>
        </div>
    </div>`;
    
    return html;
}

// 그룹화된 일정 생성 (텍스트 공간 절약)
function generateGroupedSchedules(schedules) {
    // 공통 텍스트로 그룹화
    const groups = groupSchedulesByCommonText(schedules);
    let html = '';
    
    groups.forEach(group => {
        const groupClass = group.type === 'common' ? 'common-text' : 
                          group.type === 'unique' ? 'unique-text' : 'multi-project';
        
        html += `<div class="schedule-group ${groupClass}" draggable="true">
            <div class="group-header">
                <span class="group-title">${group.title}</span>
                <span class="group-count">${group.items.length}</span>
            </div>
            <div class="group-items">`;
        
        group.items.slice(0, 3).forEach(item => {
            const researchers = item.researcher_ids ? 
                JSON.parse(item.researcher_ids).slice(0, 2).join(', ') : '';
            
            html += `<div class="group-item" onclick="editSchedule(${item.id}); event.stopPropagation();">
                <span class="item-title">${item.title}</span>
                <span class="item-researcher">${researchers}</span>
            </div>`;
        });
        
        if (group.items.length > 3) {
            html += `<div class="group-item" style="opacity: 0.7;">
                <span class="item-title">+${group.items.length - 3}개 더...</span>
            </div>`;
        }
        
        html += `</div>
        </div>`;
    });
    
    return html;
}

// 공통 텍스트로 일정 그룹화
function groupSchedulesByCommonText(schedules) {
    const groups = [];
    const processed = new Set();
    
    schedules.forEach((schedule, index) => {
        if (processed.has(index)) return;
        
        const title = schedule.title;
        const commonSchedules = [schedule];
        processed.add(index);
        
        // 비슷한 제목을 가진 일정 찾기
        schedules.forEach((otherSchedule, otherIndex) => {
            if (processed.has(otherIndex)) return;
            
            if (haveSimilarTitle(title, otherSchedule.title)) {
                commonSchedules.push(otherSchedule);
                processed.add(otherIndex);
            }
        });
        
        // 그룹 타입 결정
        let groupType = 'unique';
        let groupTitle = title;
        
        if (commonSchedules.length > 1) {
            groupType = 'common';
            groupTitle = extractCommonText(commonSchedules.map(s => s.title));
        }
        
        groups.push({
            type: groupType,
            title: groupTitle,
            items: commonSchedules
        });
    });
    
    return groups;
}

// 비슷한 제목 확인
function haveSimilarTitle(title1, title2) {
    const words1 = title1.split(' ');
    const words2 = title2.split(' ');
    const commonWords = words1.filter(word => words2.includes(word));
    return commonWords.length >= Math.min(words1.length, words2.length) * 0.6;
}

// 공통 텍스트 추출
function extractCommonText(titles) {
    if (titles.length === 1) return titles[0];
    
    let commonText = '';
    const words = titles[0].split(' ');
    
    words.forEach(word => {
        if (titles.every(title => title.includes(word))) {
            commonText += word + ' ';
        }
    });
    
    return commonText.trim() || titles[0].substring(0, 10) + '...';
}

// 아코디언 초기화
function initializeAccordions() {
    // 이미 이벤트가 추가되어 있으므로 별도 작업 불필요
}

// 계획 그룹 토글
function togglePlanGroup(header) {
    const content = header.nextElementSibling;
    const arrow = header.querySelector('.toggle-arrow');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        header.classList.add('collapsed');
    } else {
        content.classList.add('show');
        header.classList.remove('collapsed');
    }
}

// 드래그 앤 드롭 초기화
function initializeDragAndDrop() {
    const scheduleGroups = document.querySelectorAll('.schedule-group[draggable="true"]');
    const weekCells = document.querySelectorAll('.week-cell');
    
    scheduleGroups.forEach(group => {
        group.addEventListener('dragstart', handleDragStart);
        group.addEventListener('dragend', handleDragEnd);
    });
    
    weekCells.forEach(cell => {
        cell.addEventListener('dragover', handleDragOver);
        cell.addEventListener('drop', handleDrop);
        cell.addEventListener('dragenter', handleDragEnter);
        cell.addEventListener('dragleave', handleDragLeave);
    });
}

// 드래그 시작
function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', 'schedule-group');
    e.target.classList.add('dragging');
}

// 드래그 종료
function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

// 드래그 오버
function handleDragOver(e) {
    e.preventDefault();
}

// 드래그 진입
function handleDragEnter(e) {
    e.preventDefault();
    e.target.classList.add('drag-over');
}

// 드래그 나가기
function handleDragLeave(e) {
    e.target.classList.remove('drag-over');
}

// 드롭 처리
function handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove('drag-over');
    // 실제 드롭 로직은 추후 구현
}

// 월의 주차 수 계산
function getWeeksInMonth(year, month) {
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const firstWeek = Math.ceil((firstDay.getDate() + firstDay.getDay()) / 7);
    const lastWeek = Math.ceil((lastDay.getDate() + firstDay.getDay()) / 7);
    return Math.max(4, lastWeek);
}

// 새 계획 추가
function addNewPlan() {
    document.getElementById('planModalTitle').textContent = '계획 추가';
    document.getElementById('planForm').reset();
    document.getElementById('planId').value = '';
    document.getElementById('deletePlanBtn').style.display = 'none';
    
    new bootstrap.Modal(document.getElementById('planModal')).show();
}

// 계획 저장
function savePlan() {
    const planName = document.getElementById('planName').value;
    const planProjectId = document.getElementById('planProjectId').value;
    
    if (!planName.trim()) {
        alert('계획명을 입력해주세요.');
        return;
    }
    
    // 새 계획 추가 (로컬에서만)
    const newPlan = {
        id: 'custom_' + Date.now(),
        name: planName,
        project_id: planProjectId,
        schedules: []
    };
    
    plans.push(newPlan);
    
    bootstrap.Modal.getInstance(document.getElementById('planModal')).hide();
    generateThreeMonthView();
}

// 일정 모달 열기
function openScheduleModal(month, week, year, planId) {
    document.getElementById('scheduleModalTitle').textContent = '일정 추가';
    document.getElementById('scheduleForm').reset();
    document.getElementById('scheduleId').value = '';
    document.getElementById('schedulePlanId').value = planId;
    document.getElementById('modalStartMonth').value = month;
    document.getElementById('modalStartWeek').value = week;
    document.getElementById('modalEndWeek').value = week;
    document.getElementById('modalStartYear').value = year;
    document.getElementById('deleteScheduleBtn').style.display = 'none';
    
    new bootstrap.Modal(document.getElementById('scheduleModal')).show();
}

// 일정 수정
function editSchedule(id) {
    const schedule = schedules.find(s => s.id === id);
    if (!schedule) return;
    
    document.getElementById('scheduleModalTitle').textContent = '일정 수정';
    document.getElementById('scheduleId').value = schedule.id;
    document.getElementById('modalTitle').value = schedule.title;
    document.getElementById('modalStartWeek').value = schedule.start_week;
    document.getElementById('modalEndWeek').value = schedule.end_week;
    document.getElementById('modalStartMonth').value = schedule.start_month;
    document.getElementById('modalStartYear').value = schedule.start_year;
    document.getElementById('modalResearchers').value = schedule.researcher_ids ? 
        JSON.parse(schedule.researcher_ids).join(', ') : '';
    document.getElementById('modalMemo').value = schedule.memo || '';
    document.getElementById('deleteScheduleBtn').style.display = 'inline-block';
    
    new bootstrap.Modal(document.getElementById('scheduleModal')).show();
}

// 일정 저장
function saveSchedule() {
    const planId = document.getElementById('schedulePlanId').value;
    const plan = plans.find(p => p.id === planId);
    
    const formData = {
        project_id: plan ? plan.project_id : null,
        title: document.getElementById('modalTitle').value,
        start_week: parseInt(document.getElementById('modalStartWeek').value),
        end_week: parseInt(document.getElementById('modalEndWeek').value),
        start_month: parseInt(document.getElementById('modalStartMonth').value),
        start_year: parseInt(document.getElementById('modalStartYear').value),
        researcher_ids: JSON.stringify(document.getElementById('modalResearchers').value.split(',').map(s => s.trim()).filter(s => s)),
        memo: document.getElementById('modalMemo').value
    };
    
    const scheduleId = document.getElementById('scheduleId').value;
    const url = scheduleId ? `/research/schedule/projects/${scheduleId}` : '/research/schedule/projects/add';
    const method = scheduleId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
            loadSchedules();
        } else {
            alert('저장 중 오류가 발생했습니다.');
        }
    })
    .catch(error => {
        console.error('저장 오류:', error);
        alert('저장 중 오류가 발생했습니다.');
    });
}

// 일정 삭제
function deleteSchedule() {
    const scheduleId = document.getElementById('scheduleId').value;
    if (!scheduleId) return;
    
    if (confirm('이 일정을 삭제하시겠습니까?')) {
        fetch(`/research/schedule/projects/${scheduleId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
                loadSchedules();
            } else {
                alert('삭제 중 오류가 발생했습니다.');
            }
        })
        .catch(error => {
            console.error('삭제 오류:', error);
            alert('삭제 중 오류가 발생했습니다.');
        });
    }
}

// 필터링
function filterSchedules() {
    // 필터링 로직 구현
    generateThreeMonthView();
}

// 필터 초기화
function resetFilters() {
    document.getElementById('projectFilter').value = '';
    document.getElementById('researcherFilter').value = '';
    document.getElementById('searchInput').value = '';
    filterSchedules();
}

// 네비게이션
function goToPreviousMonth() {
    currentMonth--;
    if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
    }
    generateThreeMonthView();
}

function goToNextMonth() {
    currentMonth++;
    if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
    }
    generateThreeMonthView();
}

function goToToday() {
    currentMonth = new Date().getMonth() + 1;
    currentYear = new Date().getFullYear();
    generateThreeMonthView();
}

// 엑셀 내보내기
function exportToExcel() {
    alert('엑셀 내보내기 기능은 추후 구현 예정입니다.');
}
</script>
{% endblock %}