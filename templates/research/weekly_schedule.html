{% extends "base.html" %}

{% block title %}주간 일정 관리{% endblock %}

{% block extra_head %}
<style>
/* 컨테이너 및 기본 스타일 */
.schedule-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-radius: 12px;
    color: white;
}

.controls-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.view-mode-toggle {
    display: flex;
    background: white;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid #dee2e6;
}

.view-mode-toggle button {
    border: none;
    padding: 0.5rem 1rem;
    background: white;
    color: #6c757d;
    transition: all 0.2s;
}

.view-mode-toggle button.active {
    background: #007bff;
    color: white;
}

.nav-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.nav-btn {
    background: #007bff;
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    transition: all 0.2s;
}

.nav-btn:hover {
    background: #0056b3;
}

/* 2단 테이블 헤더 구조 */
.weekly-table-container {
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    background: white;
}

.weekly-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

/* 1행: 월 헤더 */
.month-header {
    background: linear-gradient(135deg, #495057 0%, #343a40 100%);
    color: white;
    text-align: center;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 1rem 0.5rem;
    border: 1px solid #6c757d;
}

.month-header.current-month {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

/* 2행: 주차 헤더 */
.week-header {
    background: #f8f9fa;
    color: #495057;
    text-align: center;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 0.75rem 0.5rem;
    border: 1px solid #dee2e6;
}

.week-header.current-week {
    background: #e3f2fd;
    color: #0056b3;
    font-weight: 700;
}

/* 프로젝트/연구원 이름 열 */
.project-name-cell {
    background: #f8f9fa;
    padding: 1rem;
    font-weight: 600;
    color: #495057;
    border: 1px solid #dee2e6;
    position: relative;
    min-width: 200px;
    max-width: 250px;
}

.project-name-cell .project-title {
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.project-name-cell .project-researcher {
    font-size: 0.8rem;
    color: #6c757d;
    font-weight: normal;
}

.project-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.project-name-cell:hover .project-actions {
    opacity: 1;
}

.action-btn {
    background: none;
    border: none;
    color: #6c757d;
    padding: 0.25rem;
    border-radius: 4px;
    transition: all 0.2s;
    font-size: 0.8rem;
}

.action-btn:hover {
    background: #e9ecef;
    color: #495057;
}

/* 일정 셀 */
.schedule-cell {
    border: 1px solid #dee2e6;
    padding: 0.5rem;
    min-height: 80px;
    vertical-align: top;
    position: relative;
    background: white;
    cursor: pointer;
    transition: background-color 0.2s;
}

.schedule-cell:hover {
    background: #f8f9fa;
}

.schedule-cell.has-schedule {
    background: #e3f2fd;
}

.schedule-cell.has-schedule:hover {
    background: #bbdefb;
}

.schedule-cell.current-week {
    border-left: 3px solid #007bff;
}

/* 일정 아이템 */
.schedule-item {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 0.4rem 0.6rem;
    margin-bottom: 0.3rem;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.schedule-item:last-child {
    margin-bottom: 0;
}

.schedule-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

.schedule-item.multi-week {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
}

.schedule-item.high-priority {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
}

.schedule-item.completed {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    opacity: 0.7;
}

.schedule-title {
    font-weight: 600;
    margin-bottom: 0.2rem;
    line-height: 1.2;
}

.schedule-meta {
    font-size: 0.7rem;
    opacity: 0.9;
}

/* 빈 셀 추가 버튼 */
.add-schedule-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #007bff;
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
    cursor: pointer;
    font-size: 0.9rem;
}

.schedule-cell:hover .add-schedule-btn {
    opacity: 1;
}

/* 일정 상세 토글 */
.schedule-details {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0 0 4px 4px;
    padding: 0.75rem;
    margin-top: 0.3rem;
    font-size: 0.8rem;
    color: #495057;
    display: none;
    position: relative;
    z-index: 10;
}

.schedule-details.show {
    display: block;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.detail-label {
    font-weight: 600;
    color: #6c757d;
}

/* 드래그 앤 드롭 */
.schedule-item.dragging {
    opacity: 0.5;
    transform: rotate(3deg) scale(0.95);
}

.schedule-cell.drag-over {
    background: #c3e6cb !important;
    border: 2px dashed #28a745;
}

.schedule-cell.drag-highlight {
    background: #fff3cd !important;
    border: 2px dashed #ffc107;
}

/* 드래그로 범위 선택 */
.schedule-cell.range-start {
    border-left: 3px solid #28a745;
    background: #d4edda !important;
}

.schedule-cell.range-middle {
    background: #d4edda !important;
}

.schedule-cell.range-end {
    border-right: 3px solid #28a745;
    background: #d4edda !important;
}

/* 행 추가 버튼 */
.add-row-section {
    background: #f8f9fa;
    border: 2px dashed #007bff;
    color: #007bff;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 8px;
    margin-top: 1rem;
}

.add-row-section:hover {
    background: #e3f2fd;
    border-color: #0056b3;
}

/* 툴팁 */
.schedule-tooltip {
    position: absolute;
    background: #333;
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    z-index: 1000;
    max-width: 200px;
    display: none;
    pointer-events: none;
}

.schedule-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: #333;
}

/* 반응형 */
@media (max-width: 1200px) {
    .weekly-table {
        min-width: 1000px;
    }
    
    .project-name-cell {
        min-width: 150px;
        max-width: 180px;
    }
    
    .schedule-cell {
        min-height: 70px;
    }
}

@media (max-width: 768px) {
    .controls-section {
        flex-direction: column;
        align-items: stretch;
    }
    
    .view-mode-toggle,
    .nav-controls {
        justify-content: center;
    }
    
    .schedule-cell {
        min-height: 60px;
        padding: 0.3rem;
    }
    
    .schedule-item {
        font-size: 0.75rem;
        padding: 0.3rem 0.4rem;
    }
}

/* 편집 모드 */
.edit-mode .schedule-cell {
    border: 2px dashed #007bff;
}

.edit-mode .add-schedule-btn {
    opacity: 0.5;
}

.edit-mode .schedule-cell:hover .add-schedule-btn {
    opacity: 1;
}

/* 로딩 상태 */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}

.loading-spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 헤더 섹션 -->
    <div class="header-section">
        <h2 class="mb-0">
            <i class="fas fa-calendar-week me-2"></i>주간 일정 관리
        </h2>
        <div class="d-flex gap-2">
            <button class="btn btn-light btn-sm" onclick="exportToExcel()">
                <i class="fas fa-file-excel me-1"></i>엑셀 내보내기
            </button>
            <button class="btn btn-success btn-sm" onclick="addNewProject()">
                <i class="fas fa-plus me-1"></i>프로젝트 추가
            </button>
        </div>
    </div>

    <!-- 컨트롤 섹션 -->
    <div class="controls-section">
        <div class="view-mode-toggle">
            <button class="active" onclick="setViewMode('view')">보기 모드</button>
            <button onclick="setViewMode('edit')">편집 모드</button>
        </div>
        
        <div class="d-flex gap-3 align-items-center">
            <select class="form-select form-select-sm" style="width: auto;" id="yearSelect" onchange="changeYear()">
                <option value="2024">2024년</option>
                <option value="2025" selected>2025년</option>
                <option value="2026">2026년</option>
            </select>
            
            <div class="nav-controls">
                <button class="nav-btn" onclick="goToPreviousMonth()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="nav-btn" onclick="goToToday()">오늘</button>
                <button class="nav-btn" onclick="goToNextMonth()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 일정표 컨테이너 -->
    <div class="schedule-container">
        <div class="weekly-table-container">
            <table class="weekly-table" id="weeklyTable">
                <!-- 테이블 내용은 JavaScript로 동적 생성 -->
            </table>
        </div>
        
        <!-- 행 추가 버튼 -->
        <div class="add-row-section" onclick="addNewProject()">
            <i class="fas fa-plus me-2"></i>새 프로젝트/연구원 추가
        </div>
    </div>
</div>

<!-- 프로젝트 추가/수정 모달 -->
<div class="modal fade" id="projectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="projectModalTitle">프로젝트 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="projectForm">
                    <input type="hidden" id="projectId">
                    <div class="mb-3">
                        <label class="form-label">프로젝트명</label>
                        <input type="text" class="form-control" id="projectName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">담당 연구원</label>
                        <input type="text" class="form-control" id="projectResearcher" placeholder="연구원 이름">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-danger" id="deleteProjectBtn" onclick="deleteProject()" style="display: none;">삭제</button>
                <button type="button" class="btn btn-primary" onclick="saveProject()">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- 일정 추가/수정 모달 -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleModalTitle">일정 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <input type="hidden" id="scheduleId">
                    <input type="hidden" id="scheduleProjectName">
                    <input type="hidden" id="scheduleWeekId">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">일정 제목</label>
                            <input type="text" class="form-control" id="scheduleTitle" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">상세 설명</label>
                            <textarea class="form-control" id="scheduleDescription" rows="3"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">시작 주차</label>
                            <select class="form-select" id="startWeekSelect" required>
                                <!-- 동적 생성 -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">종료 주차</label>
                            <select class="form-select" id="endWeekSelect" required>
                                <!-- 동적 생성 -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">상태</label>
                            <select class="form-select" id="scheduleStatus">
                                <option value="계획">계획</option>
                                <option value="진행중">진행중</option>
                                <option value="완료">완료</option>
                                <option value="보류">보류</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">우선순위</label>
                            <select class="form-select" id="schedulePriority">
                                <option value="낮음">낮음</option>
                                <option value="보통" selected>보통</option>
                                <option value="높음">높음</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-danger" id="deleteScheduleBtn" onclick="deleteSchedule()" style="display: none;">삭제</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- 툴팁 -->
<div class="schedule-tooltip" id="scheduleTooltip"></div>

<script>
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;
let isEditMode = false;
let projects = [];
let weeks = [];
let schedules = [];
let dragStartCell = null;
let dragEndCell = null;
let isDragging = false;

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadWeeks();
    loadProjects();
    loadSchedules();
    generateTable();
    
    // 드래그 선택 이벤트
    document.addEventListener('mousedown', startDragSelection);
    document.addEventListener('mousemove', updateDragSelection);
    document.addEventListener('mouseup', endDragSelection);
});

// 주차 데이터 로드 및 생성
function loadWeeks() {
    // 현재 월을 기준으로 3개월간의 주차 생성
    weeks = [];
    const months = [currentMonth - 1, currentMonth, currentMonth + 1];
    
    months.forEach(month => {
        const adjustedMonth = month <= 0 ? 12 + month : month > 12 ? month - 12 : month;
        const adjustedYear = month <= 0 ? currentYear - 1 : month > 12 ? currentYear + 1 : currentYear;
        
        for (let week = 1; week <= 5; week++) {
            weeks.push({
                id: `${adjustedYear}_${adjustedMonth}_${week}`,
                month: adjustedMonth,
                year: adjustedYear,
                week_number: week,
                start_date: null,
                end_date: null
            });
        }
    });
}

// 프로젝트 목록 로드
function loadProjects() {
    // 임시 데이터 - 실제로는 API에서 로드
    projects = [
        { id: 1, name: '신약 개발 프로젝트', researcher: '김연구' },
        { id: 2, name: '바이오 센서 연구', researcher: '이박사' },
        { id: 3, name: '나노 소재 분석', researcher: '박교수' }
    ];
}

// 일정 목록 로드
function loadSchedules() {
    // 임시 데이터 - 실제로는 API에서 로드
    schedules = [
        {
            id: 1,
            project_name: '신약 개발 프로젝트',
            week_id: `${currentYear}_${currentMonth}_1`,
            title: '시료 준비',
            description: '실험용 시료 준비 및 전처리 작업',
            start_week_id: `${currentYear}_${currentMonth}_1`,
            end_week_id: `${currentYear}_${currentMonth}_2`,
            status: '진행중',
            priority: '높음'
        },
        {
            id: 2,
            project_name: '바이오 센서 연구',
            week_id: `${currentYear}_${currentMonth}_2`,
            title: '센서 테스트',
            description: '바이오 센서 성능 테스트',
            start_week_id: `${currentYear}_${currentMonth}_2`,
            end_week_id: `${currentYear}_${currentMonth}_3`,
            status: '계획',
            priority: '보통'
        }
    ];
}

// 테이블 생성
function generateTable() {
    const table = document.getElementById('weeklyTable');
    const months = [currentMonth - 1, currentMonth, currentMonth + 1];
    const currentDate = new Date();
    const currentWeek = getWeekOfMonth(currentDate);
    
    let html = '';
    
    // 1행: 월 헤더
    html += '<tr>';
    html += '<td class="project-name-cell" style="border: none;"></td>'; // 빈 셀
    
    months.forEach((month, monthIndex) => {
        const adjustedMonth = month <= 0 ? 12 + month : month > 12 ? month - 12 : month;
        const adjustedYear = month <= 0 ? currentYear - 1 : month > 12 ? currentYear + 1 : currentYear;
        const monthName = adjustedMonth + '월';
        const isCurrentMonth = adjustedMonth === currentDate.getMonth() + 1 && adjustedYear === currentDate.getFullYear();
        
        html += `<td class="month-header ${isCurrentMonth ? 'current-month' : ''}" colspan="5">${monthName}</td>`;
    });
    html += '</tr>';
    
    // 2행: 주차 헤더
    html += '<tr>';
    html += '<td class="project-name-cell" style="border: none;"></td>'; // 빈 셀
    
    months.forEach(month => {
        const adjustedMonth = month <= 0 ? 12 + month : month > 12 ? month - 12 : month;
        const adjustedYear = month <= 0 ? currentYear - 1 : month > 12 ? currentYear + 1 : currentYear;
        
        for (let week = 1; week <= 5; week++) {
            const isCurrentWeek = adjustedMonth === currentDate.getMonth() + 1 && 
                                  adjustedYear === currentDate.getFullYear() && 
                                  week === currentWeek;
            html += `<td class="week-header ${isCurrentWeek ? 'current-week' : ''}">${week}주</td>`;
        }
    });
    html += '</tr>';
    
    // 프로젝트별 행
    projects.forEach(project => {
        html += generateProjectRow(project, months, currentWeek, currentDate);
    });
    
    table.innerHTML = html;
    
    // 툴팁 이벤트 추가
    addTooltipEvents();
    // 드래그 앤 드롭 초기화
    initializeDragAndDrop();
}

// 프로젝트 행 생성
function generateProjectRow(project, months, currentWeek, currentDate) {
    let html = '<tr>';
    
    // 프로젝트명 셀
    html += `<td class="project-name-cell">
        <div class="project-title">${project.name}</div>
        <div class="project-researcher">${project.researcher}</div>
        <div class="project-actions">
            <button class="action-btn" onclick="editProject(${project.id})" title="편집">
                <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn" onclick="deleteProject(${project.id})" title="삭제">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>`;
    
    // 주차별 셀
    months.forEach(month => {
        const adjustedMonth = month <= 0 ? 12 + month : month > 12 ? month - 12 : month;
        const adjustedYear = month <= 0 ? currentYear - 1 : month > 12 ? currentYear + 1 : currentYear;
        
        for (let week = 1; week <= 5; week++) {
            const weekId = `${adjustedYear}_${adjustedMonth}_${week}`;
            const isCurrentWeek = adjustedMonth === currentDate.getMonth() + 1 && 
                                  adjustedYear === currentDate.getFullYear() && 
                                  week === currentWeek;
            
            const weekSchedules = schedules.filter(s => 
                s.project_name === project.name && 
                isWeekInRange(weekId, s.start_week_id, s.end_week_id)
            );
            
            const hasSchedule = weekSchedules.length > 0;
            
            html += `<td class="schedule-cell ${hasSchedule ? 'has-schedule' : ''} ${isCurrentWeek ? 'current-week' : ''}" 
                data-project="${project.name}" data-week="${weekId}" 
                onclick="openScheduleModal('${project.name}', '${weekId}')">`;
            
            if (hasSchedule) {
                weekSchedules.forEach(schedule => {
                    html += generateScheduleItem(schedule);
                });
            } else {
                html += `<div class="add-schedule-btn">
                    <i class="fas fa-plus"></i>
                </div>`;
            }
            
            html += '</td>';
        }
    });
    
    html += '</tr>';
    return html;
}

// 일정 아이템 생성
function generateScheduleItem(schedule) {
    let itemClass = 'schedule-item';
    if (schedule.priority === '높음') itemClass += ' high-priority';
    if (schedule.status === '완료') itemClass += ' completed';
    if (isMultiWeekSchedule(schedule)) itemClass += ' multi-week';
    
    return `<div class="${itemClass}" draggable="true" data-schedule-id="${schedule.id}"
        onclick="editSchedule(${schedule.id}); event.stopPropagation();"
        onmouseover="showTooltip(event, ${schedule.id})"
        onmouseout="hideTooltip()">
        <div class="schedule-title">${schedule.title}</div>
        <div class="schedule-meta">${schedule.status}</div>
    </div>`;
}

// 주차가 범위 내에 있는지 확인
function isWeekInRange(weekId, startWeekId, endWeekId) {
    const [year, month, week] = weekId.split('_').map(Number);
    const [startYear, startMonth, startWeek] = startWeekId.split('_').map(Number);
    const [endYear, endMonth, endWeek] = endWeekId.split('_').map(Number);
    
    const weekNum = year * 1000 + month * 10 + week;
    const startNum = startYear * 1000 + startMonth * 10 + startWeek;
    const endNum = endYear * 1000 + endMonth * 10 + endWeek;
    
    return weekNum >= startNum && weekNum <= endNum;
}

// 다중 주차 일정인지 확인
function isMultiWeekSchedule(schedule) {
    return schedule.start_week_id !== schedule.end_week_id;
}

// 월의 주차 계산
function getWeekOfMonth(date) {
    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
    const currentWeek = Math.ceil((date.getDate() + firstDay.getDay()) / 7);
    return currentWeek;
}

// 툴팁 이벤트 추가
function addTooltipEvents() {
    // 이미 HTML에서 처리됨
}

// 툴팁 표시
function showTooltip(event, scheduleId) {
    const schedule = schedules.find(s => s.id === scheduleId);
    if (!schedule) return;
    
    const tooltip = document.getElementById('scheduleTooltip');
    tooltip.innerHTML = `
        <strong>${schedule.title}</strong><br>
        ${schedule.description || '설명 없음'}<br>
        <small>상태: ${schedule.status} | 우선순위: ${schedule.priority}</small>
    `;
    
    tooltip.style.display = 'block';
    tooltip.style.left = event.pageX + 10 + 'px';
    tooltip.style.top = event.pageY - 10 + 'px';
}

// 툴팁 숨기기
function hideTooltip() {
    document.getElementById('scheduleTooltip').style.display = 'none';
}

// 드래그 앤 드롭 초기화
function initializeDragAndDrop() {
    const scheduleItems = document.querySelectorAll('.schedule-item[draggable="true"]');
    const scheduleCells = document.querySelectorAll('.schedule-cell');
    
    scheduleItems.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
    });
    
    scheduleCells.forEach(cell => {
        cell.addEventListener('dragover', handleDragOver);
        cell.addEventListener('drop', handleDrop);
        cell.addEventListener('dragenter', handleDragEnter);
        cell.addEventListener('dragleave', handleDragLeave);
    });
}

// 드래그 시작
function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.dataset.scheduleId);
    e.target.classList.add('dragging');
}

// 드래그 종료
function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

// 드래그 오버
function handleDragOver(e) {
    e.preventDefault();
}

// 드래그 진입
function handleDragEnter(e) {
    e.preventDefault();
    e.target.classList.add('drag-over');
}

// 드래그 나가기
function handleDragLeave(e) {
    e.target.classList.remove('drag-over');
}

// 드롭 처리
function handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove('drag-over');
    
    const scheduleId = e.dataTransfer.getData('text/plain');
    const newWeekId = e.target.dataset.week;
    const newProject = e.target.dataset.project;
    
    moveSchedule(scheduleId, newProject, newWeekId);
}

// 일정 이동
function moveSchedule(scheduleId, newProject, newWeekId) {
    // 실제 구현에서는 서버 API 호출
    console.log(`일정 ${scheduleId}를 ${newProject}의 ${newWeekId}로 이동`);
    loadSchedules();
    generateTable();
}

// 드래그 선택 시작
function startDragSelection(e) {
    if (!isEditMode || !e.target.classList.contains('schedule-cell')) return;
    
    isDragging = true;
    dragStartCell = e.target;
    e.preventDefault();
}

// 드래그 선택 업데이트
function updateDragSelection(e) {
    if (!isDragging) return;
    
    const cell = e.target.closest('.schedule-cell');
    if (!cell) return;
    
    dragEndCell = cell;
    highlightRange(dragStartCell, dragEndCell);
}

// 드래그 선택 종료
function endDragSelection(e) {
    if (!isDragging) return;
    
    isDragging = false;
    
    if (dragStartCell && dragEndCell) {
        openRangeScheduleModal(dragStartCell, dragEndCell);
    }
    
    clearRangeHighlight();
    dragStartCell = null;
    dragEndCell = null;
}

// 범위 강조 표시
function highlightRange(startCell, endCell) {
    clearRangeHighlight();
    
    // 범위 계산 로직 (간단화)
    const cells = document.querySelectorAll('.schedule-cell');
    let inRange = false;
    
    cells.forEach(cell => {
        if (cell === startCell || cell === endCell) {
            inRange = !inRange;
            cell.classList.add(cell === startCell ? 'range-start' : 'range-end');
        } else if (inRange) {
            cell.classList.add('range-middle');
        }
    });
}

// 범위 강조 해제
function clearRangeHighlight() {
    document.querySelectorAll('.schedule-cell').forEach(cell => {
        cell.classList.remove('range-start', 'range-middle', 'range-end');
    });
}

// 범위 일정 모달 열기
function openRangeScheduleModal(startCell, endCell) {
    const startWeek = startCell.dataset.week;
    const endWeek = endCell.dataset.week;
    const project = startCell.dataset.project;
    
    openScheduleModal(project, startWeek, endWeek);
}

// 보기 모드 설정
function setViewMode(mode) {
    isEditMode = (mode === 'edit');
    
    document.querySelectorAll('.view-mode-toggle button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    const table = document.querySelector('.weekly-table-container');
    if (isEditMode) {
        table.classList.add('edit-mode');
    } else {
        table.classList.remove('edit-mode');
    }
}

// 새 프로젝트 추가
function addNewProject() {
    document.getElementById('projectModalTitle').textContent = '프로젝트 추가';
    document.getElementById('projectForm').reset();
    document.getElementById('projectId').value = '';
    document.getElementById('deleteProjectBtn').style.display = 'none';
    
    new bootstrap.Modal(document.getElementById('projectModal')).show();
}

// 프로젝트 편집
function editProject(id) {
    const project = projects.find(p => p.id === id);
    if (!project) return;
    
    document.getElementById('projectModalTitle').textContent = '프로젝트 수정';
    document.getElementById('projectId').value = project.id;
    document.getElementById('projectName').value = project.name;
    document.getElementById('projectResearcher').value = project.researcher;
    document.getElementById('deleteProjectBtn').style.display = 'inline-block';
    
    new bootstrap.Modal(document.getElementById('projectModal')).show();
}

// 프로젝트 저장
function saveProject() {
    const name = document.getElementById('projectName').value;
    const researcher = document.getElementById('projectResearcher').value;
    const id = document.getElementById('projectId').value;
    
    if (!name.trim()) {
        alert('프로젝트명을 입력해주세요.');
        return;
    }
    
    if (id) {
        // 수정
        const project = projects.find(p => p.id == id);
        if (project) {
            project.name = name;
            project.researcher = researcher;
        }
    } else {
        // 추가
        const newProject = {
            id: Date.now(),
            name: name,
            researcher: researcher
        };
        projects.push(newProject);
    }
    
    bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
    generateTable();
}

// 프로젝트 삭제
function deleteProject(id) {
    if (confirm('이 프로젝트와 관련된 모든 일정이 삭제됩니다. 계속하시겠습니까?')) {
        projects = projects.filter(p => p.id !== id);
        schedules = schedules.filter(s => {
            const project = projects.find(p => p.id === id);
            return project ? s.project_name !== project.name : true;
        });
        
        if (document.getElementById('projectModal').classList.contains('show')) {
            bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
        }
        
        generateTable();
    }
}

// 일정 모달 열기
function openScheduleModal(projectName, weekId, endWeekId = null) {
    document.getElementById('scheduleModalTitle').textContent = '일정 추가';
    document.getElementById('scheduleForm').reset();
    document.getElementById('scheduleId').value = '';
    document.getElementById('scheduleProjectName').value = projectName;
    document.getElementById('scheduleWeekId').value = weekId;
    document.getElementById('deleteScheduleBtn').style.display = 'none';
    
    // 주차 선택 옵션 생성
    updateWeekSelects(weekId, endWeekId);
    
    new bootstrap.Modal(document.getElementById('scheduleModal')).show();
}

// 주차 선택 옵션 업데이트
function updateWeekSelects(defaultWeekId, defaultEndWeekId = null) {
    const startSelect = document.getElementById('startWeekSelect');
    const endSelect = document.getElementById('endWeekSelect');
    
    startSelect.innerHTML = '';
    endSelect.innerHTML = '';
    
    weeks.forEach(week => {
        const weekText = `${week.year}년 ${week.month}월 ${week.week_number}주`;
        const option1 = new Option(weekText, week.id);
        const option2 = new Option(weekText, week.id);
        
        if (week.id === defaultWeekId) {
            option1.selected = true;
            option2.selected = true;
        } else if (week.id === defaultEndWeekId) {
            option2.selected = true;
        }
        
        startSelect.add(option1);
        endSelect.add(option2);
    });
}

// 일정 편집
function editSchedule(id) {
    const schedule = schedules.find(s => s.id === id);
    if (!schedule) return;
    
    document.getElementById('scheduleModalTitle').textContent = '일정 수정';
    document.getElementById('scheduleId').value = schedule.id;
    document.getElementById('scheduleTitle').value = schedule.title;
    document.getElementById('scheduleDescription').value = schedule.description || '';
    document.getElementById('scheduleStatus').value = schedule.status;
    document.getElementById('schedulePriority').value = schedule.priority;
    document.getElementById('deleteScheduleBtn').style.display = 'inline-block';
    
    updateWeekSelects(schedule.start_week_id, schedule.end_week_id);
    
    new bootstrap.Modal(document.getElementById('scheduleModal')).show();
}

// 일정 저장
function saveSchedule() {
    const title = document.getElementById('scheduleTitle').value;
    const description = document.getElementById('scheduleDescription').value;
    const startWeekId = document.getElementById('startWeekSelect').value;
    const endWeekId = document.getElementById('endWeekSelect').value;
    const status = document.getElementById('scheduleStatus').value;
    const priority = document.getElementById('schedulePriority').value;
    const projectName = document.getElementById('scheduleProjectName').value;
    const id = document.getElementById('scheduleId').value;
    
    if (!title.trim()) {
        alert('일정 제목을 입력해주세요.');
        return;
    }
    
    const scheduleData = {
        project_name: projectName,
        week_id: startWeekId,
        title: title,
        description: description,
        start_week_id: startWeekId,
        end_week_id: endWeekId,
        status: status,
        priority: priority
    };
    
    if (id) {
        // 수정
        const schedule = schedules.find(s => s.id == id);
        if (schedule) {
            Object.assign(schedule, scheduleData);
        }
    } else {
        // 추가
        scheduleData.id = Date.now();
        schedules.push(scheduleData);
    }
    
    bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
    generateTable();
}

// 일정 삭제
function deleteSchedule() {
    const id = document.getElementById('scheduleId').value;
    if (!id) return;
    
    if (confirm('이 일정을 삭제하시겠습니까?')) {
        schedules = schedules.filter(s => s.id != id);
        bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
        generateTable();
    }
}

// 네비게이션
function goToPreviousMonth() {
    currentMonth--;
    if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
    }
    loadWeeks();
    generateTable();
}

function goToNextMonth() {
    currentMonth++;
    if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
    }
    loadWeeks();
    generateTable();
}

function goToToday() {
    currentMonth = new Date().getMonth() + 1;
    currentYear = new Date().getFullYear();
    loadWeeks();
    generateTable();
}

function changeYear() {
    currentYear = parseInt(document.getElementById('yearSelect').value);
    loadWeeks();
    generateTable();
}

// 엑셀 내보내기
function exportToExcel() {
    alert('엑셀 내보내기 기능은 추후 구현 예정입니다.');
}
</script>
{% endblock %}